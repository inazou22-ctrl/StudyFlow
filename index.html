<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>StudyFlow</title>

<!-- ==========================================
     アイコン自動生成スクリプト (シンプル＆モダン版)
     ========================================== -->
<script>
(function() {
    function generateIcon() {
        const size = 512;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        // --- 1. 背景：単色のディープ・スレート ---
        // グラデーションなしのマットな質感で高級感を出す
        ctx.fillStyle = '#1e293b'; // Slate-800
        
        // アイコン形状（角丸正方形）
        ctx.beginPath();
        const r = 90; // 角丸の半径
        ctx.moveTo(r, 0);
        ctx.lineTo(size - r, 0);
        ctx.quadraticCurveTo(size, 0, size, r);
        ctx.lineTo(size, size - r);
        ctx.quadraticCurveTo(size, size, size - r, size);
        ctx.lineTo(r, size);
        ctx.quadraticCurveTo(0, size, 0, size - r);
        ctx.lineTo(0, r);
        ctx.quadraticCurveTo(0, 0, r, 0);
        ctx.fill();

        // --- 2. モチーフ：バイカラーの本 ---
        // 中央に配置するための座標計算
        const centerX = size / 2;
        const centerY = size / 2;
        const bookW = 320;
        const bookH = 360;
        const pageW = bookW / 2;
        
        // 左ページ (スカイブルー)
        // 外側の角だけ丸くする
        ctx.fillStyle = '#0ea5e9'; // Sky-500
        ctx.beginPath();
        ctx.moveTo(centerX, centerY - bookH/2); // 背表紙上
        ctx.lineTo(centerX - pageW + 40, centerY - bookH/2); // 左上（角丸手前）
        ctx.quadraticCurveTo(centerX - pageW, centerY - bookH/2, centerX - pageW, centerY - bookH/2 + 40); // 左上角
        ctx.lineTo(centerX - pageW, centerY + bookH/2 - 40); // 左下（角丸手前）
        ctx.quadraticCurveTo(centerX - pageW, centerY + bookH/2, centerX - pageW + 40, centerY + bookH/2); // 左下角
        ctx.lineTo(centerX, centerY + bookH/2); // 背表紙下
        ctx.fill();

        // 右ページ (ホワイト)
        ctx.fillStyle = '#f8fafc'; // Slate-50
        ctx.beginPath();
        ctx.moveTo(centerX, centerY - bookH/2); // 背表紙上
        ctx.lineTo(centerX + pageW - 40, centerY - bookH/2); // 右上（角丸手前）
        ctx.quadraticCurveTo(centerX + pageW, centerY - bookH/2, centerX + pageW, centerY - bookH/2 + 40); // 右上角
        ctx.lineTo(centerX + pageW, centerY + bookH/2 - 40); // 右下（角丸手前）
        ctx.quadraticCurveTo(centerX + pageW, centerY + bookH/2, centerX + pageW - 40, centerY + bookH/2); // 右下角
        ctx.lineTo(centerX, centerY + bookH/2); // 背表紙下
        ctx.fill();

        // --- 3. ロゴ：「S」のネガティブスペース表現 ---
        // 文字の設定
        ctx.font = 'bold 240px "Inter", sans-serif'; 
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // 凝った演出：左ページ（青）の上には白い文字、右ページ（白）の上には青い文字を描く
        // これにより、色が反転してつながっているような「凝った」視覚効果を出す

        // 左半分のクリッピング領域を設定して描画
        ctx.save();
        ctx.beginPath();
        ctx.rect(0, 0, centerX, size);
        ctx.clip();
        ctx.fillStyle = '#f8fafc'; // 左側の文字色（白）
        ctx.fillText('S', centerX, centerY + 15);
        ctx.restore();

        // 右半分のクリッピング領域を設定して描画
        ctx.save();
        ctx.beginPath();
        ctx.rect(centerX, 0, size, size);
        ctx.clip();
        ctx.fillStyle = '#0ea5e9'; // 右側の文字色（青）
        ctx.fillText('S', centerX, centerY + 15);
        ctx.restore();

        // --- 4. アクセント：背表紙のライン ---
        // ページの継ぎ目をスタイリッシュに見せる細い線
        ctx.strokeStyle = 'rgba(30, 41, 59, 0.1)'; // 薄い影色
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY - bookH/2);
        ctx.lineTo(centerX, centerY + bookH/2);
        ctx.stroke();

        return canvas.toDataURL('image/png');
    }

    const iconUrl = generateIcon();

    // 2. HTMLのheadにアイコン設定を追加
    const head = document.head;

    // Favicon (ブラウザタブ用)
    const linkFavicon = document.createElement('link');
    linkFavicon.rel = 'icon';
    linkFavicon.type = 'image/png';
    linkFavicon.href = iconUrl;
    head.appendChild(linkFavicon);

    // Apple Touch Icon (iOSホーム画面用)
    const linkApple = document.createElement('link');
    linkApple.rel = 'apple-touch-icon';
    linkApple.href = iconUrl;
    head.appendChild(linkApple);

    // 3. PWAマニフェスト (Androidホーム画面用)
    const manifest = {
        name: "StudyFlow",
        short_name: "StudyFlow",
        start_url: ".",
        display: "standalone",
        background_color: "#f8fafc",
        theme_color: "#1e293b",
        orientation: "portrait",
        icons: [
            { src: iconUrl, sizes: "512x512", type: "image/png" },
            { src: iconUrl, sizes: "192x192", type: "image/png" }
        ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestUrl = URL.createObjectURL(blob);
    const linkManifest = document.createElement('link');
    linkManifest.rel = 'manifest';
    linkManifest.href = manifestUrl;
    head.appendChild(linkManifest);
})();
</script>

<!-- PWA設定 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="StudyFlow">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
    
    /* アプリ全体の高さを固定し、スクロールを制御 */
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    /* メインコンテンツのみスクロール可能にする */
    #main-scroll-area {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* iOSでの慣性スクロール */
        overscroll-behavior-y: contain;
    }

    .glass-card{background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);border-radius:1rem;box-shadow:0 4px 6px -1px rgb(0 0 0/0.05);position:relative;transition:transform .2s ease;overflow:hidden}
    
    /* Focus Mode: 全画面を覆う */
    .focus-mode{position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100vh!important;z-index:2000!important;margin:0!important;padding:2rem!important;border-radius:0!important;display:flex!important;flex-direction:column!important;justify-content:center!important;background:#fff!important;overflow-y:auto!important;border:none!important}
    
    .timer-text-large{font-size:4rem;line-height:1}
    .focus-mode .timer-text-large{font-size:8rem!important}
    .focus-mode .problem-timer-text-large{font-size:5rem!important}
    .focus-mode #review-list{max-height:80vh!important}.page-transition{transition:all .3s ease}.hidden-page{display:none}
    .quick-tag{font-size:11px;font-weight:700;padding:8px 12px;border-radius:12px;background:#fff;border:1px solid #e2e8f0;color:#0ea5e9;box-shadow:0 2px 4px rgba(0,0,0,0.02);transition:all .1s}.quick-tag:active{background:#f1f5f9;transform:translateY(1px)}
    .btn-main{display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.4,0,.2,1)}.btn-main:active{transform:scale(.95)}
    .day-cell{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;font-size:.75rem;border-radius:.25rem}
    .heat-0{background-color:#f1f5f9}.heat-1{background-color:#bae6fd}.heat-2{background-color:#7dd3fc}.heat-3{background-color:#38bdf8}.heat-4{background-color:#0ea5e9}
    .week-bar{width:100%;background-color:#f1f5f9;border-radius:999px;overflow:hidden;display:flex;flex-direction:column-reverse;height:100%;position:relative}
    .week-bar-fill{background:linear-gradient(to top,#0ea5e9,#38bdf8);width:100%;transition:height .5s cubic-bezier(0.4,0,0.2,1);height:0}
    .week-bar-container{height:6rem}.timeline-grid{display:grid;grid-template-columns:35px repeat(7,1fr);gap:3px}
    .timeline-time-label{font-size:9px;color:#94a3b8;text-align:right;padding-right:4px;height:14px;display:flex;align-items:center;justify-content:flex-end}
    .timeline-cell{height:14px;border-radius:2px;background-color:#f1f5f9}
    .hour-heat-1{background-color:#bae6fd}.hour-heat-2{background-color:#7dd3fc}.hour-heat-3{background-color:#38bdf8}.hour-heat-4{background-color:#0ea5e9}
    .subject-bar-container{background:#f1f5f9;height:8px;border-radius:4px;overflow:hidden;margin-top:4px}
    .subject-bar-fill{background:#0ea5e9;height:100%;border-radius:4px;transition:width .6s cubic-bezier(.16,1,.3,1)}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:3000;visibility:hidden;opacity:0;transition:.3s}.modal.active{visibility:visible;opacity:1}
    .goal-progress-bar{height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden}.goal-progress-fill{height:100%;background:#0ea5e9;transition:width .3s ease}
    .goal-toggle,.stats-toggle{display:flex;background:#f1f5f9;padding:2px}.goal-toggle{border-radius:6px}.stats-toggle{border-radius:8px;width:fit-content}
    .goal-toggle button,.stats-toggle button{font-weight:700;border-radius:4px}.goal-toggle button{padding:2px 8px;font-size:9px}.stats-toggle button{padding:4px 12px;font-size:10px;border-radius:6px}
    .goal-toggle button.active,.stats-toggle button.active{background:#fff;color:#0ea5e9;box-shadow:0 1px 2px rgba(0,0,0,.05)}.goal-toggle button.inactive,.stats-toggle button.inactive{color:#94a3b8}
    .category-chip{padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;background:#f1f5f9;color:#64748b;cursor:pointer;border:1px solid transparent}.category-chip.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .todo-item{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border:1px solid #f1f5f9;border-radius:12px;margin-bottom:8px}.todo-item.completed span{text-decoration:line-through;color:#94a3b8}
    .todo-check{width:20px;height:20px;border:2px solid #0ea5e9;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}.todo-check.active{background:#0ea5e9}.todo-check.active::after{content:'✓';color:#fff;font-size:12px;font-weight:700}
    .expand-btn{position:absolute;top:6px;right:6px;color:#94a3b8;cursor:pointer;z-index:50;width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.4,0,.2,1);border-radius:50%;background:rgba(255,255,255,.7);backdrop-filter:blur(4px);border:1px solid rgba(226,232,240,.8);box-shadow:0 2px 4px rgba(0,0,0,0.03)}
    .expand-btn:hover{color:#0ea5e9;background:#fff;transform:scale(1.1);box-shadow:0 4px 10px rgba(14,165,233,.15);border-color:#e0f2fe}.expand-btn:active{transform:scale(.95)}
    .expand-btn svg{width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
    .expand-btn .icon-compress{display:none}.expand-btn .icon-expand{display:block}.focus-mode .expand-btn .icon-expand{display:none}.focus-mode .expand-btn .icon-compress{display:block}
    .toggle-switch{position:relative;display:inline-block;width:44px;height:24px}.toggle-switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#e2e8f0;transition:.4s;border-radius:34px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}
    input:checked+.slider{background-color:#0ea5e9}input:checked+.slider:before{transform:translateX(20px)}
    .stat-badge{background:linear-gradient(135deg,#0ea5e9,#38bdf8);color:#fff;border-radius:.75rem;padding:1rem;display:flex;flex-direction:column;align-items:center;justify-content:center}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:10px}
    .ai-glow{box-shadow:0 0 15px rgba(14,165,233,.2)}
    .mode-active-indicator{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background-color:#22c55e;border-radius:50%;border:2px solid #fff}
    .priority-item{border-left:3px solid transparent}.priority-high{border-left-color:#f43f5e;background:#fff1f2}.priority-medium{border-left-color:#f97316;background:#fff7ed}
    /* Auth UI Styles */
    .auth-btn{width:100%;padding:10px;border-radius:8px;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}.auth-btn:active{transform:scale(.98)}
    .btn-google{background:#fff;border:1px solid #e2e8f0;color:#475569}.btn-google:hover{background:#f8fafc}
    .btn-email{background:#0ea5e9;color:#fff;box-shadow:0 2px 4px rgba(14,165,233,0.2)}.btn-email:hover{background:#0284c7}
    .auth-input{width:100%;padding:10px;border-radius:8px;border:1px solid #e2e8f0;font-size:12px;background:#f8fafc;outline:none;transition:.2s}.auth-input:focus{border-color:#0ea5e9;background:#fff}
</style>
</head>
<body class="h-full w-full flex flex-col bg-[#f8fafc]">
<datalist id="list-subjects"></datalist><datalist id="list-books"></datalist><datalist id="list-categories"></datalist>

<!-- ヘッダー (固定) -->
<header class="flex-none bg-white z-50 shadow-sm px-4 py-2 border-b border-slate-100" id="main-header">
    <div class="flex justify-between items-center mb-1">
        <h1 class="text-lg font-bold text-sky-600 flex items-center"><i class="fas fa-layer-group mr-2"></i>StudyFlow</h1>
        <div class="flex items-center gap-3">
            <div class="goal-toggle">
                <button id="goal-toggle-day" onclick="setGoalScope('day')" class="active">今日</button>
                <button id="goal-toggle-week" onclick="setGoalScope('week')" class="inactive">今週</button>
                <button id="goal-toggle-month" onclick="setGoalScope('month')" class="inactive">今月</button>
            </div>
            <div id="total-time-display" class="text-[10px] font-bold text-slate-500">今日: 00:00:00</div>
        </div>
    </div>
    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
        <div id="header-goal-fill" class="h-full bg-sky-400 transition-all duration-500 w-0"></div>
    </div>
    <div class="flex justify-between mt-1">
        <span id="header-goal-text" class="text-[9px] font-bold text-slate-400 uppercase">Goal: --</span>
        <span id="header-goal-percent" class="text-[9px] font-bold text-sky-500">0%</span>
    </div>
</header>

<!-- メインコンテンツ (スクロールエリア) -->
<main class="flex-1 overflow-y-auto w-full bg-[#f8fafc]" id="main-scroll-area">
    <div class="w-full max-w-md mx-auto p-4 pb-24">
    <!-- Home Page -->
    <div id="page-home" class="page-transition space-y-6">
        <section id="section-timer" class="glass-card p-6 text-center border-l-4 border-sky-400">
            <button onclick="toggleFocus('section-timer')" class="expand-btn" id="btn-expand-section-timer"><svg class="icon-expand" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></svg><svg class="icon-compress" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg></button>
            <div class="flex justify-center space-x-2 mb-6">
                <button onclick="setTimerMode('stopwatch')" id="btn-stopwatch" class="relative text-xs px-4 py-1.5 rounded-full bg-sky-100 text-sky-600 font-bold transition-all">ストップウォッチ<span id="ind-stopwatch" class="hidden mode-active-indicator"></span></button>
                <button onclick="setTimerMode('timer')" id="btn-timer" class="relative text-xs px-4 py-1.5 rounded-full bg-gray-100 text-gray-500 transition-all">タイマー<span id="ind-timer" class="hidden mode-active-indicator"></span></button>
                <button onclick="setTimerMode('pomodoro')" id="btn-pomodoro" class="relative text-xs px-4 py-1.5 rounded-full bg-gray-100 text-gray-500 transition-all">ポモドーロ<span id="ind-pomodoro" class="hidden mode-active-indicator"></span></button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1">教科 (必須)</label><input type="text" id="timer-subject" list="list-subjects" placeholder="教科を入力" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-center outline-none focus:border-sky-300 transition-colors"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1">分野 (必須)</label><input type="text" id="timer-category" list="list-categories" placeholder="分野を入力" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-center outline-none focus:border-sky-300 transition-colors"></div>
            </div>
            <div id="timer-display" class="text-6xl font-mono font-bold text-slate-700 tabular-nums tracking-tight mb-6 timer-text-large" style="display:block;">00:00:00</div>
            <div id="pomodoro-setting-panel" class="hidden mb-4 p-3 bg-sky-50 rounded-xl grid grid-cols-2 gap-4">
                <div><label class="block text-[10px] font-bold text-sky-600 mb-1">集中 (分)</label><input type="number" id="pomo-work-min" value="25" onchange="updatePomodoroWorkTime()" class="w-full text-center text-sm font-bold bg-white border border-sky-100 rounded p-1"></div>
                <div><label class="block text-[10px] font-bold text-sky-600 mb-1">休憩 (分)</label><input type="number" id="pomo-break-min" value="5" onchange="updatePomodoroBreakTime()" class="w-full text-center text-sm font-bold bg-white border border-sky-100 rounded p-1"></div>
            </div>
            <div id="quick-adjust-panel" class="hidden mb-4 flex justify-center flex-wrap gap-2"><button onclick="adjustTime(1800)" class="quick-tag">+30分</button><button onclick="adjustTime(600)" class="quick-tag">+10分</button><button onclick="adjustTime(60)" class="quick-tag">+1分</button><button onclick="adjustTime(-60)" class="quick-tag text-slate-400">-1分</button></div>
            <div class="flex justify-center items-center gap-6">
                <button onclick="resetTimer()" class="w-16 h-16 bg-slate-50 text-slate-400 rounded-2xl flex flex-col items-center justify-center border border-slate-100 hover:bg-slate-100 transition-colors"><i class="fas fa-undo-alt text-lg mb-1"></i><span class="text-[10px] font-bold">リセット</span></button>
                <button id="timer-toggle" onclick="toggleTimer()" class="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg flex flex-col items-center justify-center"><i class="fas fa-play text-xl mb-1"></i><span id="timer-toggle-label" class="text-xs font-bold uppercase">学習開始</span></button>
                <div class="w-16"></div>
            </div>
            <div id="pomo-sub-actions" class="hidden mt-4 text-center"></div>
            <p id="timer-status" class="mt-4 text-[10px] text-slate-400 font-bold uppercase tracking-widest">Ready to Study</p>
        </section>

        <section id="section-eval" class="glass-card p-5 border-l-4 border-sky-400">
            <button onclick="toggleFocus('section-eval')" class="expand-btn" id="btn-expand-section-eval"><svg class="icon-expand" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></svg><svg class="icon-compress" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg></button>
            <div class="mb-3 pr-10 border-b border-slate-50 pb-2"><h2 class="font-bold flex items-center text-slate-600 text-sm"><i class="fas fa-pen-nib mr-2 text-sky-500"></i>例題評価・演習</h2></div>
            <div class="mb-3 flex items-center justify-end bg-slate-50 p-2 rounded-lg gap-2"><span class="text-[10px] font-bold text-slate-400">復習:</span><select id="eval-filter" onchange="seekNextProblem()" class="text-[10px] bg-white border border-slate-200 rounded px-2 py-1 font-bold text-slate-600 outline-none"><option value="all">すべて表示</option><option value="le4">Lv.4以下 (復習推奨)</option><option value="le3">Lv.3以下 (要復習)</option><option value="le2">Lv.2以下 (苦手)</option><option value="le1">Lv.1のみ (不明)</option></select></div>
            <div class="bg-slate-50 rounded-xl p-3 mb-4 border border-slate-100">
                <div class="flex justify-between items-center mb-2"><div class="flex flex-col"><span class="text-[10px] text-slate-400 font-bold uppercase">Time</span><span id="problem-timer-display" class="text-3xl font-mono font-bold text-slate-700 leading-none tabular-nums problem-timer-text-large">00:00</span></div><button id="problem-timer-btn" onclick="toggleProblemTimer()" class="bg-sky-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm active:bg-sky-600"><i id="problem-timer-icon" class="fas fa-play mr-2"></i>計測開始</button></div>
                <div class="flex items-center justify-between border-t border-slate-200 pt-2"><div class="flex items-center gap-2"><label class="flex items-center text-[10px] font-bold text-slate-500 cursor-pointer"><i class="fas fa-bell mr-1 text-sky-400"></i>制限</label><input type="number" id="problem-timer-limit" placeholder="0" class="w-12 bg-white border border-slate-200 rounded p-1 text-center text-xs font-bold focus:border-sky-400 outline-none" min="0" step="0.1" onchange="updateCountdownDisplay()"><span class="text-[10px] font-bold text-slate-400">分</span></div><span id="problem-countdown-display" class="text-xs font-mono font-bold text-slate-300">--:--</span></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3"><input type="text" id="input-subject" list="list-subjects" placeholder="教科" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none focus:border-sky-300" oninput="updateLastLapDisplay()"><input type="text" id="input-book" list="list-books" placeholder="教材" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none focus:border-sky-300" oninput="updateLastLapDisplay()"></div>
            <input type="text" id="input-category" list="list-categories" placeholder="分野 (例: 微分積分)" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none mb-3 focus:border-sky-300" oninput="updateLastLapDisplay()">
            <div class="flex items-center justify-between mb-4 bg-white border border-slate-100 p-2 rounded-xl shadow-sm"><div class="flex items-center gap-2"><span id="lbl-no" class="text-xs font-bold text-slate-400">No.</span><input type="number" id="input-problem-no" value="1" class="w-20 bg-slate-50 border border-slate-100 rounded-lg p-1.5 text-sm text-center outline-none font-bold text-slate-700" onchange="updateLastLapDisplay()"></div><div class="text-right flex items-center gap-3"><div class="flex flex-col items-center"><span class="text-[8px] font-bold text-slate-300 uppercase">前回Lv</span><span id="prev-eval-badge" class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded">--</span></div><div class="flex flex-col items-center"><span class="text-[8px] font-bold text-slate-300 uppercase">前回Time</span><span id="prev-time-badge" class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">--:--</span></div></div></div>
            <div id="real-no-hint" class="hidden text-[9px] text-slate-400 text-right mb-2 pr-1">元No: --</div>
            <div class="grid grid-cols-5 gap-2">
                <button onclick="recordEvaluation(1)" class="bg-red-50 text-red-600 p-3 rounded-xl flex flex-col items-center hover:bg-red-100 active:scale-95 transition-all"><span class="text-lg font-bold">1</span><span class="text-[8px] font-bold">不明</span></button>
                <button onclick="recordEvaluation(2)" class="bg-orange-50 text-orange-600 p-3 rounded-xl flex flex-col items-center hover:bg-orange-100 active:scale-95 transition-all"><span class="text-lg font-bold">2</span><span class="text-[8px] font-bold">不安</span></button>
                <button onclick="recordEvaluation(3)" class="bg-yellow-50 text-yellow-600 p-3 rounded-xl flex flex-col items-center hover:bg-yellow-100 active:scale-95 transition-all"><span class="text-lg font-bold">3</span><span class="text-[8px] font-bold">普通</span></button>
                <button onclick="recordEvaluation(4)" class="bg-green-50 text-green-500 p-3 rounded-xl flex flex-col items-center hover:bg-green-100 active:scale-95 transition-all"><span class="text-lg font-bold">4</span><span class="text-[8px] font-bold">理解</span></button>
                <button onclick="recordEvaluation(5)" class="bg-blue-50 text-blue-500 p-3 rounded-xl flex flex-col items-center hover:bg-blue-100 active:scale-95 transition-all"><span class="text-lg font-bold">5</span><span class="text-[8px] font-bold">完璧</span></button>
            </div>
        </section>

        <section id="section-manual" class="glass-card p-5 border-l-4 border-emerald-400">
            <h2 class="font-bold flex items-center text-slate-600 text-sm mb-4"><i class="fas fa-plus-circle mr-2 text-emerald-500"></i>勉強時間を記録</h2>
            <div class="grid grid-cols-2 gap-3 mb-3"><input type="text" id="manual-subject" list="list-subjects" placeholder="教科 (例: 英語)" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none"><input type="text" id="manual-category" list="list-categories" placeholder="分野 (例: 文法)" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none"></div>
            <div class="flex items-center bg-slate-50 border border-slate-100 rounded-lg px-2 mb-3"><input type="number" id="manual-minutes" placeholder="分入力" class="w-full bg-transparent p-2 text-sm outline-none text-right"><span class="text-[10px] font-bold text-slate-400 ml-1">分</span></div>
            <div class="flex items-center gap-2 mb-3"><input type="date" id="manual-date" class="flex-grow bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-slate-500"><input type="time" id="manual-start-time" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-slate-500 w-24"></div>
            <button onclick="submitManualTime()" class="w-full bg-emerald-500 text-white py-3 rounded-lg text-xs font-bold shadow-sm active:bg-emerald-600 flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> 記録を保存</button>
        </section>

        <section id="section-review" class="glass-card p-4 border-l-4 border-slate-400">
            <button onclick="toggleFocus('section-review')" class="expand-btn" id="btn-expand-section-review"><svg class="icon-expand" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></svg><svg class="icon-compress" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg></button>
            <div class="flex flex-col space-y-3 mb-4">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">復習・全履歴</p>
                <div class="grid grid-cols-2 gap-2">
                    <select id="list-filter-type" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全種類</option><option value="evaluation">評価</option><option value="manual">手動</option></select>
                    <select id="list-filter-level" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全Lv</option><option value="le1">Lv.1以下</option><option value="le2">Lv.2以下</option><option value="le3">Lv.3以下</option><option value="le4">Lv.4以下</option></select>
                    <select id="list-filter-subject" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全教科</option></select>
                    <select id="list-filter-category" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全分野</option></select>
                </div>
            </div>
            <div id="review-list" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1"></div>
        </section>
    </div>

    <!-- Analytics Page -->
    <div id="page-analytics" class="page-transition hidden-page space-y-6">
        <div id="section-priority" class="glass-card p-5 border-l-4 border-sky-400 ai-glow relative overflow-hidden">
            <div class="absolute right-3 top-3 opacity-10 pointer-events-none"><i class="fas fa-sort-amount-up text-5xl text-sky-500"></i></div>
            <div class="flex items-center gap-2 mb-3"><div class="bg-sky-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px]"><i class="fas fa-list-ol"></i></div><p class="text-xs font-bold text-slate-600 uppercase tracking-widest">優先度</p></div>
            <div id="priority-list" class="space-y-2 relative z-10"></div>
            <p id="priority-empty-msg" class="text-[10px] text-slate-400 text-center mt-2 hidden relative z-10">データが不足しています。学習を記録すると表示されます。</p>
        </div>

        <div id="section-achievements" class="grid grid-cols-2 gap-3">
            <div id="rank-card" class="col-span-2 glass-card p-4 border-b-4 border-slate-300 flex flex-col items-center text-center relative overflow-hidden transition-all duration-500">
                <div class="absolute top-0 left-0 w-full h-1 bg-slate-100/50"><div id="rank-progress" class="h-full bg-slate-400" style="width:0%"></div></div>
                <span id="stat-rank-title" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">現在の称号</span>
                <div class="flex items-end gap-1 my-1"><span id="stat-rank" class="text-3xl font-black text-slate-500 leading-none">F</span><span id="stat-rank-label" class="text-xs font-bold text-slate-500 mb-1">ランク</span></div>
                <p id="stat-rank-text" class="text-[10px] font-medium text-slate-500 leading-tight">...</p>
                <p id="stat-next-rank" class="text-[8px] font-bold text-slate-300 mt-2">次のランクまであと -- 時間</p>
            </div>
            <div class="stat-badge shadow-sm"><span class="text-[9px] font-bold uppercase opacity-80">累計学習時間</span><span id="stat-total-hours" class="text-xl font-bold">--h</span></div>
            <div class="stat-badge shadow-sm bg-gradient-to-br from-indigo-500 to-purple-500"><span class="text-[9px] font-bold uppercase opacity-80">連続学習日数</span><span id="stat-streak-days" class="text-xl font-bold">--日</span></div>
        </div>

        <div id="section-radar" class="glass-card p-4 border-l-4 border-sky-400">
            <div class="flex justify-between items-center mb-4">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">理解度分析</p>
                <div id="radar-mode-label" class="text-[9px] font-bold text-sky-500 bg-sky-50 px-2 py-1 rounded">全体バランス</div>
            </div>
            <div class="relative"><canvas id="radarChart" height="250"></canvas><button id="btn-back-to-total" onclick="resetRadarMode()" class="hidden absolute top-0 right-0 text-[10px] bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold"><i class="fas fa-arrow-left mr-1"></i>戻る</button></div>
            <div id="radar-subject-chips" class="flex flex-wrap gap-2 mt-4 overflow-x-auto pb-2"></div>
        </div>

        <div id="section-subject-time" class="glass-card p-5 border-l-4 border-sky-500"><p class="text-xs font-bold text-slate-400 mb-6 uppercase tracking-widest text-center">教科別合計時間</p><div id="subject-time-list" class="space-y-6"></div></div>

        <div id="section-stats" class="glass-card p-4 border-l-4 border-indigo-400">
            <div class="flex justify-between items-center mb-4">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">学習統計</p>
                <div class="stats-toggle"><button onclick="setCalendarMode('month')" id="mode-month-btn" class="active">月</button><button onclick="setCalendarMode('week')" id="mode-week-btn" class="inactive">週</button></div>
            </div>
            <div id="calendar-month-view">
                <div class="flex justify-between items-center mb-3">
                    <button onclick="changeCalendarView(-1,'month')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><i class="fas fa-chevron-left text-[9px] text-slate-400 group-hover:text-sky-500 absolute left-1.5"></i><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">先月</span></button>
                    <span id="calendar-month-label" class="text-sm font-bold text-slate-700 tracking-wider">----年--月</span>
                    <button onclick="changeCalendarView(1,'month')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">来月</span><i class="fas fa-chevron-right text-[9px] text-slate-400 group-hover:text-sky-500 absolute right-1.5"></i></button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            </div>
            <div id="calendar-week-view" class="hidden space-y-6">
                <div class="flex justify-between items-center mb-3">
                    <button onclick="changeCalendarView(-7,'week')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><i class="fas fa-chevron-left text-[9px] text-slate-400 group-hover:text-sky-500 absolute left-1.5"></i><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">先週</span></button>
                    <span id="calendar-week-label" class="text-xs font-bold text-slate-700 tracking-wider">--/-- 〜 --/--</span>
                    <button onclick="changeCalendarView(7,'week')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">来週</span><i class="fas fa-chevron-right text-[9px] text-slate-400 group-hover:text-sky-500 absolute right-1.5"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 ml-[35px] px-1" id="week-view-container"></div>
                <div id="timeline-container" class="timeline-grid border-t pt-4 mt-2"></div>
            </div>
        </div>

        <div id="section-records" class="glass-card p-4 border-l-4 border-amber-400">
            <p class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">最高記録アワード</p>
            <div class="space-y-3">
                <div class="flex items-center justify-between bg-amber-50 p-2.5 rounded-xl"><div class="flex items-center"><i class="fas fa-trophy text-amber-400 mr-3"></i><div><p class="text-[9px] text-amber-600 font-bold">1日の最高学習時間</p><p id="record-day-val" class="text-sm font-bold text-slate-700">--</p></div></div><span id="record-day-date" class="text-[8px] text-amber-300 font-bold">----/--/--</span></div>
                <div class="flex items-center justify-between bg-sky-50 p-2.5 rounded-xl"><div class="flex items-center"><i class="fas fa-crown text-sky-400 mr-3"></i><div><p class="text-[9px] text-sky-600 font-bold">週の最高学習時間</p><p id="record-week-val" class="text-sm font-bold text-slate-700">--</p></div></div><span id="record-week-date" class="text-[8px] text-sky-300 font-bold">--週目</span></div>
                <div class="flex items-center justify-between bg-indigo-50 p-2.5 rounded-xl"><div class="flex items-center"><i class="fas fa-medal text-indigo-400 mr-3"></i><div><p class="text-[9px] text-indigo-600 font-bold">月の最高学習時間</p><p id="record-month-val" class="text-sm font-bold text-slate-700">--</p></div></div><span id="record-month-date" class="text-[8px] text-indigo-300 font-bold">----/--</span></div>
            </div>
        </div>
    </div>

    <!-- Goals/List Page -->
    <div id="page-list" class="page-transition hidden-page space-y-6">
        <div id="section-exam" class="glass-card p-5 border-l-4 border-rose-400">
            <h2 class="font-bold flex items-center text-slate-600 text-sm mb-4"><i class="fas fa-calendar-alt mr-2 text-rose-500"></i>試験カウントダウン</h2>
            <div id="exam-list-container" class="space-y-3"></div>
            <button onclick="showExamForm()" class="w-full mt-3 bg-white border border-rose-200 text-rose-500 py-2 rounded-lg text-xs font-bold hover:bg-rose-50 flex items-center justify-center gap-1"><i class="fas fa-plus"></i> 試験を追加</button>
            <div id="exam-input-area" class="hidden mt-4 pt-4 border-t border-rose-100 space-y-3">
                <p class="text-xs font-bold text-slate-500 mb-2" id="exam-form-title">試験情報を入力</p>
                <div class="grid grid-cols-2 gap-2"><input type="text" id="input-exam-name" placeholder="試験名" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-xs"><input type="date" id="input-exam-date" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-xs"></div>
                <div class="flex gap-2"><button id="btn-delete-exam" onclick="deleteExam()" class="hidden bg-red-50 text-red-400 py-2 px-3 rounded-lg text-xs font-bold flex items-center justify-center gap-1"><i class="fas fa-trash-alt"></i> 削除</button><button onclick="hideExamForm()" class="flex-1 bg-slate-100 text-slate-400 py-2 rounded-lg text-xs font-bold">キャンセル</button><button onclick="saveExam()" class="flex-1 bg-rose-500 text-white py-2 rounded-lg text-xs font-bold shadow-sm active:bg-rose-600">保存</button></div>
            </div>
        </div>
        <section id="section-todo" class="glass-card p-5 border-l-4 border-indigo-400">
            <div class="flex justify-between items-center mb-4"><h2 class="font-bold flex items-center text-slate-600 text-sm"><i class="fas fa-check-square mr-2 text-indigo-500"></i>ToDo</h2><button onclick="confirmClearTodos()" class="text-[9px] font-bold text-indigo-400 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100">完了分削除</button></div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="todo-input" placeholder="タスクを入力" class="flex-1 min-w-0 bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm focus:border-indigo-300 outline-none">
                <button onclick="addTodo()" class="shrink-0 bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap">追加</button>
            </div>
            <div id="todo-container" class="space-y-1"></div>
        </section>
        <div id="section-goals" class="glass-card p-4 border-l-4 border-indigo-500">
            <div class="flex justify-between items-center mb-4"><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">目標設定</p><button onclick="openGoalModal()" class="text-[10px] bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full font-bold hover:bg-indigo-100">教科別目標</button></div>
            <div class="bg-slate-50 p-3 rounded-xl mb-4 border border-slate-100"><div class="flex justify-between items-center mb-2"><span id="goal-setting-label" class="text-[10px] font-bold text-slate-500">今日の目標</span><div id="daily-goal-value" class="text-xs font-bold text-indigo-600">-- 時間</div></div><div class="flex gap-2"><input type="number" id="input-daily-goal" placeholder="目標時間(h)" class="flex-grow text-xs p-2 rounded border border-slate-200"><button onclick="saveDailyGoal()" class="bg-indigo-500 text-white text-[10px] px-3 py-2 rounded-lg font-bold">保存</button></div></div>
            <div id="goal-list" class="space-y-4"></div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="page-settings" class="page-transition hidden-page space-y-6">
        <div id="settings-container" class="space-y-6"></div>
    </div>
    </div>
</main>

<!-- フッターナビ (Flexアイテムとして配置) -->
<nav class="flex-none bg-white/95 backdrop-blur-md border-t flex z-[100]" style="padding-bottom: env(safe-area-inset-bottom);" id="bottom-nav">
    <button onclick="navigate('home')" id="nav-home" class="flex-1 py-4 flex flex-col items-center justify-center text-sky-600 active:bg-slate-50 transition-colors touch-manipulation">
        <i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">ホーム</span>
    </button>
    <button onclick="navigate('analytics')" id="nav-analytics" class="flex-1 py-4 flex flex-col items-center justify-center text-slate-300 active:bg-slate-50 transition-colors touch-manipulation">
        <i class="fas fa-chart-line text-xl mb-1"></i><span class="text-[10px] font-bold">分析</span>
    </button>
    <button onclick="navigate('list')" id="nav-list" class="flex-1 py-4 flex flex-col items-center justify-center text-slate-300 active:bg-slate-50 transition-colors touch-manipulation">
        <i class="fas fa-bullseye text-xl mb-1"></i><span class="text-[10px] font-bold">目標</span>
    </button>
    <button onclick="navigate('settings')" id="nav-settings" class="flex-1 py-4 flex flex-col items-center justify-center text-slate-300 active:bg-slate-50 transition-colors touch-manipulation">
        <i class="fas fa-cog text-xl mb-1"></i><span class="text-[10px] font-bold">設定</span>
    </button>
</nav>

<!-- Modals -->
<div id="confirm-modal" class="modal" onclick="if(event.target===this)closeConfirmModal()"><div class="glass-card w-11/12 max-w-xs p-6 space-y-4 shadow-2xl"><div class="text-center"><h3 id="confirm-title" class="font-bold text-slate-700">確認</h3><p id="confirm-body" class="text-[11px] text-slate-400 mt-2"></p></div><div class="flex gap-2 pt-2"><button onclick="closeConfirmModal()" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl text-xs font-bold">取消</button><button id="confirm-execute-btn" class="flex-1 bg-sky-500 text-white py-3 rounded-xl text-xs font-bold shadow-lg">実行</button></div></div></div>
<div id="edit-modal" class="modal" onclick="if(event.target===this)closeModal()"><div class="glass-card w-11/12 max-w-xs p-6 space-y-4"><h3 class="font-bold text-center text-slate-700">記録の操作</h3><p id="edit-info" class="text-[10px] text-center text-slate-400"></p><div id="evaluation-edit-panel" class="grid grid-cols-5 gap-1"><button onclick="updateLog(1)" class="bg-red-50 text-red-600 py-3 rounded-lg font-bold">1</button><button onclick="updateLog(2)" class="bg-orange-50 text-orange-600 py-3 rounded-lg font-bold">2</button><button onclick="updateLog(3)" class="bg-yellow-50 text-yellow-600 py-3 rounded-lg font-bold">3</button><button onclick="updateLog(4)" class="bg-green-50 text-green-500 py-3 rounded-lg font-bold">4</button><button onclick="updateLog(5)" class="bg-blue-50 text-blue-500 py-3 rounded-lg font-bold">5</button></div><div class="flex gap-2"><button onclick="requestDeleteLog()" class="flex-1 bg-red-50 text-red-400 py-3 rounded-xl text-xs font-bold">削除</button><button onclick="closeModal()" class="flex-1 bg-sky-500 text-white py-3 rounded-xl text-xs font-bold">戻る</button></div></div></div>
<div id="goal-modal" class="modal" onclick="if(event.target===this)closeGoalModal()"><div class="glass-card w-11/12 max-w-xs p-6 space-y-4"><h3 id="goal-modal-title" class="font-bold text-center text-slate-700">新しい学習目標</h3><div class="space-y-3"><input type="text" id="goal-title" list="list-subjects" placeholder="教科" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-3 text-sm focus:border-indigo-300 outline-none"><div class="flex items-center bg-slate-50 border border-slate-100 rounded-lg px-3"><input type="number" id="goal-target" placeholder="目標時間" class="w-full bg-transparent p-3 text-sm text-right outline-none"><span class="text-xs font-bold text-slate-400 ml-1">時間</span></div></div><div class="flex gap-2"><button id="goal-delete-btn" onclick="deleteGoalFromModal()" class="hidden bg-red-50 text-red-400 py-3 px-3 rounded-xl text-xs font-bold flex items-center justify-center gap-1"><i class="fas fa-trash-alt"></i> 削除</button><button onclick="closeGoalModal()" class="flex-1 bg-slate-50 text-slate-400 py-3 rounded-xl text-xs font-bold">取消</button><button id="goal-save-btn" onclick="saveGoalEntry()" class="flex-1 bg-indigo-500 text-white py-3 rounded-xl text-xs font-bold">保存</button></div></div></div>
<div id="msg-box" class="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white text-[10px] px-6 py-2 rounded-full opacity-0 transition-opacity z-[100] pointer-events-none"></div>

<script>
    const el=id=>document.getElementById(id);
    const elements={timerDisplay:el('timer-display'),problemTimerDisplay:el('problem-timer-display'),totalTimeDisplay:el('total-time-display'),goalList:el('goal-list'),subjectTimeList:el('subject-time-list'),reviewList:el('review-list'),msgBox:el('msg-box'),timerToggle:el('timer-toggle'),headerGoalFill:el('header-goal-fill'),headerGoalText:el('header-goal-text'),headerGoalPercent:el('header-goal-percent'),dailyGoalValue:el('daily-goal-value'),todoContainer:el('todo-container'),todoInput:el('todo-input')};
    const state={logs:JSON.parse(localStorage.getItem('studyflow_logs'))||[],timeRecords:JSON.parse(localStorage.getItem('studyflow_time'))||{},hourlyRecords:JSON.parse(localStorage.getItem('studyflow_hourly'))||{},subjectTimeRecords:JSON.parse(localStorage.getItem('studyflow_subjects'))||{},categoryTimeRecords:JSON.parse(localStorage.getItem('studyflow_categories'))||{},goals:JSON.parse(localStorage.getItem('studyflow_goals'))||[],todos:JSON.parse(localStorage.getItem('studyflow_todos'))||[],exams:JSON.parse(localStorage.getItem('studyflow_exams'))||[],dailyGoalSec:parseInt(localStorage.getItem('studyflow_daily_goal_sec'))||0,weeklyGoalSec:parseInt(localStorage.getItem('studyflow_weekly_goal_sec'))||0,monthlyGoalSec:parseInt(localStorage.getItem('studyflow_monthly_goal_sec'))||0,goalScope:localStorage.getItem('studyflow_goal_scope')||'day',history:JSON.parse(localStorage.getItem('studyflow_history'))||{subjects:[],books:[],categories:[]},featureSettings:JSON.parse(localStorage.getItem('studyflow_features'))||{'section-timer':!0,'section-todo':!0,'section-manual':!0,'section-eval':!0,'section-exam':!0,'section-radar':!0,'section-subject-time':!0,'section-goals':!0,'section-stats':!0,'section-review':!0,'section-achievements':!0,'section-records':!0,'section-priority':!0},userSettings:JSON.parse(localStorage.getItem('studyflow_user_settings'))||{pomoWork:25,pomoBreak:5,autoAddOvertime:!0},currentPage:'home',calendarMode:'month',viewDate:new Date,currentSession:{isRunning:!1,elapsed:0,mode:'stopwatch',pomoState:'work'},problemTimer:{isRunning:!1,elapsed:0},timerInterval:null,problemTimerInterval:null,editingId:null,editingGoalId:null,editingExamId:null,selectedRadarSubject:null,isFocused:!1,
    timers:{stopwatch:{isRunning:!1,elapsed:0},timer:{isRunning:!1,remaining:1800,initial:1800},pomodoro:{isRunning:!1,state:'work',remaining:1500,overtime:0}}, // Added default timers state initialization
    activeTimerMode:'stopwatch', // Added default active timer mode
    intervalStarted: false, // Flag to prevent multiple intervals
    // 認証状態管理用
    currentUser: null,
    dbAvailable: false
    };
    if(!localStorage.getItem('studyflow_exams')&&localStorage.getItem('studyflow_exam')){const old=JSON.parse(localStorage.getItem('studyflow_exam'));if(old)state.exams.push({id:Date.now(),name:old.name,date:old.date});localStorage.removeItem('studyflow_exam');localStorage.setItem('studyflow_exams',JSON.stringify(state.exams))}
    const RANKS=[{t:36e5,n:'EX',m:'1000時間を越えた者だけが立てる境地。'},{t:216e4,n:'SSS',m:'常人の域を超えた継続力を持つ者。'},{t:108e4,n:'SS',m:'量と質、その両方を積み重ねてきた証。'},{t:36e4,n:'S',m:'明確に、上位学習者の領域に入った。'},{t:108e3,n:'A',m:'努力が自信へと変わる段階に到達した。'},{t:36e3,n:'B',m:'勉強は「作業」ではなく、武器になる。'},{t:10800,n:'C',m:'続ける力が、確かな成果を生み始める。'},{t:3600,n:'D',m:'学ぶ習慣が形になりはじめた。'},{t:1800,n:'E',m:'最初の一歩を踏み出した。成長はもう始まっている。'},{t:0,n:'F',m:'まだ始まったばかり。ここからすべてが始まる。'}];
    const StudyStats={cache:null,isDirty:!0,invalidate:function(){this.isDirty=!0},get:function(){if(!this.isDirty&&this.cache)return this.cache;const timeEntries=Object.entries(state.timeRecords).filter(([_,s])=>s>0);const totalSec=Object.values(state.timeRecords).reduce((a,b)=>a+b,0);const totalHours=totalSec/3600;const currentRank=RANKS.find(r=>totalSec>=r.t)||RANKS[RANKS.length-1];const nextRank=RANKS[RANKS.indexOf(currentRank)-1]||null;let streak=0;const today=new Date;for(let i=0;i<365;i++){const d=new Date;d.setDate(today.getDate()-i);if(state.timeRecords[d.toISOString().split('T')[0]]>0)streak++;else if(i>0)break}let maxDay={val:0,date:'--'},maxWeek={val:0,date:'--'},maxMonth={val:0,date:'--'};if(timeEntries.length>0){const maxDayEntry=timeEntries.reduce((p,c)=>(p[1]>c[1])?p:c);maxDay={val:maxDayEntry[1],date:maxDayEntry[0]};const weekMap={},monthMap={};timeEntries.forEach(([ds,sec])=>{const d=new Date(ds);const weekKey=`${d.getFullYear()}-W${getWeekNumber(d)}`;const monthKey=ds.substring(0,7);weekMap[weekKey]=(weekMap[weekKey]||0)+sec;monthMap[monthKey]=(monthMap[monthKey]||0)+sec});if(Object.keys(weekMap).length>0){const w=Object.entries(weekMap).reduce((p,c)=>p[1]>c[1]?p:c);maxWeek={val:w[1],date:w[0]}}if(Object.keys(monthMap).length>0){const m=Object.entries(monthMap).reduce((p,c)=>p[1]>c[1]?p:c);maxMonth={val:m[1],date:m[0]}}}this.cache={totalSec,totalHours:totalSec/3600,rank:currentRank.n,rankText:currentRank.m,nextRank,streak,maxDay,maxWeek,maxMonth};this.isDirty=!1;return this.cache}};
    const featureLabels={'section-priority':'優先度','section-achievements':'ランク・称号','section-records':'最高記録アワード','section-exam':'試験日カウント','section-todo':'ToDoリスト','section-radar':'理解度分析'};
    const formatTime=(seconds,showHours=!0)=>{const h=Math.floor(seconds/3600),n=Math.floor((seconds%3600)/60),s=seconds%60,pad=num=>String(num).padStart(2,'0');return showHours?`${pad(h)}:${pad(n)}:${pad(s)}`:`${pad(n)}:${pad(s)}`};
    const getWeekNumber=d=>{d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));return Math.ceil((((d-new Date(Date.UTC(d.getUTCFullYear(),0,1)))/86400000)+1)/7)};
    const getTodayStr=()=>new Date().toISOString().split('T')[0];
    const pad = n => n.toString().padStart(2, '0');
    function toggleFocus(targetId){const target=el(targetId),header=el('main-header'),nav=el('bottom-nav'),icon=el(`icon-${targetId}`);if(!state.isFocused){target.classList.add('focus-mode');header.classList.add('hidden');nav.classList.add('hidden');if(icon) icon.className='fas fa-compress-arrows-alt text-[10px]';state.isFocused=!0}else{target.classList.remove('focus-mode');header.classList.remove('hidden');nav.classList.remove('hidden');if(icon) icon.className='fas fa-expand-alt text-[10px]';state.isFocused=!1}}
    function navigate(pageId){if(state.isFocused)return;if(pageId==='analytics')StudyStats.invalidate();state.currentPage=pageId;['home','analytics','list','settings'].forEach(p=>{const pageEl=el(`page-${p}`);if(pageEl)pageEl.classList.toggle('hidden-page',p!==pageId);const nav=el(`nav-${p}`);if(nav){nav.classList.toggle('text-sky-600',p===pageId);nav.classList.toggle('text-slate-300',p!==pageId)}});refreshUI()}
    function save(){
        localStorage.setItem('studyflow_logs',JSON.stringify(state.logs));localStorage.setItem('studyflow_time',JSON.stringify(state.timeRecords));localStorage.setItem('studyflow_hourly',JSON.stringify(state.hourlyRecords));localStorage.setItem('studyflow_subjects',JSON.stringify(state.subjectTimeRecords));localStorage.setItem('studyflow_categories',JSON.stringify(state.categoryTimeRecords));localStorage.setItem('studyflow_goals',JSON.stringify(state.goals));localStorage.setItem('studyflow_todos',JSON.stringify(state.todos));localStorage.setItem('studyflow_history',JSON.stringify(state.history));localStorage.setItem('studyflow_daily_goal_sec',state.dailyGoalSec);localStorage.setItem('studyflow_weekly_goal_sec',state.weeklyGoalSec);localStorage.setItem('studyflow_monthly_goal_sec',state.monthlyGoalSec);localStorage.setItem('studyflow_goal_scope',state.goalScope);localStorage.setItem('studyflow_exams',JSON.stringify(state.exams));localStorage.setItem('studyflow_features',JSON.stringify(state.featureSettings));localStorage.setItem('studyflow_user_settings',JSON.stringify(state.userSettings));
        StudyStats.invalidate();
        if(state.currentUser && state.dbAvailable && window.saveToCloud) {
            window.saveToCloud();
        }
    }
    function toggleFeature(featureId){state.featureSettings[featureId]=!state.featureSettings[featureId];save();refreshUI()}
    
    // settingsページ描画関数を認証UI対応に修正
    function renderFeatureSettings(){
        const container=el('settings-container');
        // 認証UI構築
        let authHTML = '';
        if (state.currentUser) {
            // ログイン時
            authHTML = `
                <div class="flex flex-col items-center gap-3">
                    <div class="w-16 h-16 rounded-full bg-sky-100 flex items-center justify-center overflow-hidden border-2 border-sky-200">
                        ${state.currentUser.photoURL 
                            ? `<img src="${state.currentUser.photoURL}" class="w-full h-full object-cover">` 
                            : `<i class="fas fa-user text-2xl text-sky-400"></i>`}
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-bold text-slate-700">${state.currentUser.displayName || 'No Name'}</p>
                        <p class="text-[10px] text-slate-400">${state.currentUser.email}</p>
                        <p class="text-[9px] text-green-500 mt-1"><i class="fas fa-check-circle"></i> クラウド同期有効</p>
                    </div>
                    <button onclick="window.handleLogout()" class="text-xs text-red-400 font-bold border border-red-200 px-4 py-2 rounded-full hover:bg-red-50 transition-colors">ログアウト</button>
                </div>
            `;
        } else {
            // 未ログイン時
            authHTML = `
                <div class="space-y-3">
                    <button onclick="window.handleGoogleLogin()" class="auth-btn btn-google">
                        <i class="fab fa-google text-red-500"></i> Googleでログイン
                    </button>
                    <div class="border-t border-slate-100 my-3"></div>
                    <div class="space-y-2">
                        <input type="email" id="auth-email" placeholder="メールアドレス" class="auth-input">
                        <input type="password" id="auth-password" placeholder="パスワード" class="auth-input">
                        <div class="flex gap-2">
                            <button onclick="window.handleEmailLogin()" class="auth-btn btn-email flex-1">ログイン</button>
                            <button onclick="window.handleEmailSignup()" class="auth-btn bg-slate-100 text-slate-600 hover:bg-slate-200 flex-1">新規登録</button>
                        </div>
                    </div>
                </div>
            `;
        }

        container.innerHTML=`
            <div class="glass-card p-6 border-l-4 border-indigo-500 mb-4">
                <h2 class="font-bold flex items-center text-slate-600 text-sm mb-4"><i class="fas fa-user-circle mr-2 text-indigo-500"></i>アカウント設定</h2>
                ${authHTML}
            </div>
            
            <div class="glass-card p-6 border-l-4 border-slate-600">
                <h2 class="font-bold flex items-center text-slate-600 text-sm mb-6"><i class="fas fa-eye mr-2 text-slate-500"></i>表示カスタマイズ</h2>
                <div class="space-y-4 mb-8">${Object.keys(featureLabels).map(id=>`<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="text-xs font-bold text-slate-700">${featureLabels[id]}</span><label class="toggle-switch"><input type="checkbox" ${state.featureSettings[id]?'checked':''} onchange="toggleFeature('${id}')"><span class="slider"></span></label></div>`).join('')}</div>
                <h2 class="font-bold flex items-center text-slate-600 text-sm mb-6"><i class="fas fa-clock mr-2 text-slate-500"></i>ポモドーロ設定</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="text-xs font-bold text-slate-700">休憩超過分を勉強時間に加算</span><label class="toggle-switch"><input type="checkbox" id="setting-auto-overtime" ${state.userSettings.autoAddOvertime?'checked':''} onchange="saveUserSettings()"><span class="slider"></span></label></div>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-100 text-center flex justify-center gap-4">
                    <button onclick="exportData()" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl text-xs font-bold"><i class="fas fa-download mr-1"></i>データ保存</button>
                    <button onclick="resetAllData()" class="flex-1 bg-red-50 text-red-400 py-3 rounded-xl text-xs font-bold"><i class="fas fa-trash-alt mr-1"></i>全初期化</button>
                </div>
            </div>`;
    }

    function refreshUI(){Object.keys(state.featureSettings).forEach(id=>{const section=el(id);if(section)section.classList.toggle('hidden',!state.featureSettings[id])});['subjects','books','categories'].forEach(key=>{const dl=el(`list-${key}`);if(dl)dl.innerHTML=state.history[key].map(s=>`<option value="${s}">`).join('')});updateTotalDisplay();if (!state.intervalStarted){state.intervalStarted=!0;setInterval(globalTimerLoop,1000)}if(state.currentPage==='home'){renderReviewList();updatePrioritySuggestions();updateLastLapDisplay();}if(state.currentPage==='analytics'){renderRadar();renderSubjectTime();state.calendarMode==='month'?renderMonthCalendar():renderWeekCalendar();renderAchievements();updatePrioritySuggestions();}if(state.currentPage==='list'){renderExam();renderTodos();renderGoals()}if(state.currentPage==='settings')renderFeatureSettings()}
    function globalTimerLoop(){const now=new Date(),dateStr=getTodayStr();let currentModeRunning=!1;if(state.timers.stopwatch.isRunning){state.timers.stopwatch.elapsed++;if(state.activeTimerMode==='stopwatch')currentModeRunning=!0}if(state.timers.timer.isRunning){state.timers.timer.remaining--;if(state.activeTimerMode==='timer')currentModeRunning=!0;if(state.timers.timer.remaining<=0){state.timers.timer.remaining=0;state.timers.timer.isRunning=!1;showMessage("タイマー終了！");updateTimerDisplay()}}if(state.timers.pomodoro.isRunning){state.timers.pomodoro.remaining--;if(state.activeTimerMode==='pomodoro')currentModeRunning=!0;if(state.timers.pomodoro.remaining<=0){state.timers.pomodoro.remaining=0;state.timers.pomodoro.isRunning=!1;const isWork=state.timers.pomodoro.state==='work';showMessage(isWork?"お疲れ様！休憩しましょう":"休憩終了！頑張りましょう");updateTimerDisplay()}}if(!state.timers.pomodoro.isRunning&&state.timers.pomodoro.remaining===0&&state.timers.pomodoro.state==='break'){state.timers.pomodoro.overtime=(state.timers.pomodoro.overtime||0)+1;if(state.activeTimerMode==='pomodoro')updateTimerDisplay()}if(currentModeRunning)updateTimerDisplay();['stopwatch','timer','pomodoro'].forEach(mode=>{const ind=el(`ind-${mode}`);if(ind)ind.classList.toggle('hidden',!state.timers[mode].isRunning)});const isLearning=state.timers.stopwatch.isRunning||state.timers.timer.isRunning||(state.timers.pomodoro.isRunning&&state.timers.pomodoro.state==='work');if(isLearning){const sub=el('timer-subject').value.trim()||"その他";const cat=el('timer-category').value.trim();state.timeRecords[dateStr]=(state.timeRecords[dateStr]||0)+1;state.subjectTimeRecords[sub]=(state.subjectTimeRecords[sub]||0)+1;if(cat){const catKey=sub+':'+cat;state.categoryTimeRecords[catKey]=(state.categoryTimeRecords[catKey]||0)+1;}if(!state.hourlyRecords[dateStr])state.hourlyRecords[dateStr]=new Array(24).fill(0);state.hourlyRecords[dateStr][now.getHours()]++;updateTotalDisplay((state.timeRecords[dateStr]||0));if(now.getSeconds()%30===0)save()}}
    function saveUserSettings(){state.userSettings.autoAddOvertime=el('setting-auto-overtime').checked;save();showMessage("設定を保存しました")}
    function toggleTimer(){const mode=state.activeTimerMode;if(mode==='pomodoro')return;const timer=state.timers[mode];if(!timer.isRunning){const cat=el('timer-category').value.trim();if(!cat){showMessage("分野を入力してください");el('timer-category').focus();return;}}timer.isRunning=!timer.isRunning;if(!timer.isRunning)save();updateTimerDisplay()}
    function setTimerMode(m){state.activeTimerMode=m;['stopwatch','timer','pomodoro'].forEach(mode=>{const btn=el(`btn-${mode}`);if(btn)btn.className=mode===m?'relative text-xs px-4 py-1.5 rounded-full bg-sky-100 text-sky-600 font-bold transition-all':'relative text-xs px-4 py-1.5 rounded-full bg-gray-100 text-gray-500 transition-all'});el('quick-adjust-panel').classList.toggle('hidden',m!=='timer');el('pomodoro-setting-panel').classList.toggle('hidden',m!=='pomodoro');if(m==='pomodoro'&&el('pomo-work-min')){el('pomo-work-min').value=state.userSettings.pomoWork;el('pomo-break-min').value=state.userSettings.pomoBreak;if(!state.timers.pomodoro.isRunning&&state.timers.pomodoro.state==='work')state.timers.pomodoro.remaining=state.userSettings.pomoWork*60}updateTimerDisplay()}
    function updTmrDisplay(){updateTimerDisplay()}
    function updateTimerDisplay(){const mode=state.activeTimerMode,timer=state.timers[mode],btn=elements.timerToggle,statusEl=el('timer-status'),displayEl=elements.timerDisplay,subActions=el('pomo-sub-actions'),sectionTimer=el('section-timer'),isFocused=sectionTimer.classList.contains('focus-mode');sectionTimer.classList.remove('urgent-mode');let baseClass="glass-card p-6 text-center border-l-4 border-sky-400";if(isFocused)baseClass+=" focus-mode";sectionTimer.className=baseClass;let displayTime=0;if(mode==='stopwatch')displayTime=timer.elapsed;else if(mode==='timer')displayTime=timer.remaining;if(mode!=='pomodoro'){displayEl.innerText=formatTime(displayTime);displayEl.className="text-6xl font-mono font-bold text-slate-700 tabular-nums tracking-tight mb-6 timer-text-large";subActions.classList.add('hidden');if(timer.isRunning){btn.innerHTML='<i class="fas fa-pause text-xl mb-1"></i><span class="text-xs font-bold uppercase">一時停止</span>';btn.className="btn-main w-32 h-16 bg-orange-500 text-white rounded-2xl shadow-lg";statusEl.innerText=mode==='timer'?"Timer Running...":"Counting..."}else{const isResume=(mode==='timer'&&timer.remaining>0&&timer.remaining<timer.initial)||(mode==='stopwatch'&&timer.elapsed>0);btn.innerHTML='<i class="fas fa-play text-xl mb-1"></i><span class="text-xs font-bold uppercase">'+(isResume?'再開':'学習開始')+'</span>';btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";statusEl.innerText="Ready to Study"}btn.onclick=toggleTimer}else{const isWork=timer.state==='work';if(!isWork){subActions.classList.remove('hidden');subActions.innerHTML=`<button onclick="startPomoWork()" class="text-xs font-bold text-sky-400 underline hover:text-sky-500">休憩を終了して勉強する</button>`;if(timer.remaining>0){displayEl.innerText=formatTime(timer.remaining);displayEl.className="text-6xl font-mono font-bold text-teal-400 tabular-nums tracking-tight mb-6 timer-text-large"}else{displayEl.innerText=formatTime(timer.overtime||0);displayEl.className="text-6xl font-mono font-bold text-orange-400 tabular-nums tracking-tight mb-6 timer-text-large"}}else{subActions.classList.add('hidden');displayEl.innerText=formatTime(timer.remaining);displayEl.className="text-6xl font-mono font-bold text-slate-700 tabular-nums tracking-tight mb-6 timer-text-large"}if(timer.remaining<=0){if(isWork){btn.innerHTML='<i class="fas fa-mug-hot text-xl mb-1"></i><span class="text-xs font-bold uppercase">休憩開始</span>';btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";statusEl.innerText="Work Done!";btn.onclick=startPomoBreak}else{btn.innerHTML='<i class="fas fa-book-open text-xl mb-1"></i><span class="text-xs font-bold uppercase">勉強再開</span>';btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";statusEl.innerText="Break Done!";btn.onclick=startPomoWork}}else{if(timer.isRunning){btn.innerHTML='<i class="fas fa-pause text-xl mb-1"></i><span class="text-xs font-bold uppercase">一時停止</span>';btn.className="btn-main w-32 h-16 bg-orange-500 text-white rounded-2xl shadow-lg";statusEl.innerText=isWork?"Focusing...":"Relaxing...";btn.onclick=()=>{timer.isRunning=!1;save();updateTimerDisplay()}}else{btn.innerHTML='<i class="fas fa-play text-xl mb-1"></i><span class="text-xs font-bold uppercase">再開</span>';btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";statusEl.innerText="Paused";btn.onclick=()=>{const cat=el('timer-category').value.trim();if(!cat){showMessage("分野を入力してください");el('timer-category').focus();return;}timer.isRunning=!0;updateTimerDisplay()}}}}}
    function updatePomodoroWorkTime(){const val=parseInt(el('pomo-work-min').value)||25;state.userSettings.pomoWork=val;save();if(!state.timers.pomodoro.isRunning&&state.timers.pomodoro.state==='work'){state.timers.pomodoro.remaining=val*60;updateTimerDisplay()}}
    function updatePomodoroBreakTime(){const val=parseInt(el('pomo-break-min').value)||5;state.userSettings.pomoBreak=val;save();if(!state.timers.pomodoro.isRunning&&state.timers.pomodoro.state==='break'){state.timers.pomodoro.remaining=val*60;updateTimerDisplay()}}
    function adjustTime(v){if(state.activeTimerMode==='timer'){state.timers.timer.remaining=Math.max(0,state.timers.timer.remaining+v);updateTimerDisplay()}}
    function resetTimer(){const mode=state.activeTimerMode,timer=state.timers[mode];timer.isRunning=!1;if(mode==='stopwatch')timer.elapsed=0;else if(mode==='timer')timer.remaining=0;else if(mode==='pomodoro'){timer.state='work';timer.remaining=state.userSettings.pomoWork*60;timer.overtime=0;if(el('pomo-work-min'))el('pomo-work-min').value=state.userSettings.pomoWork;if(el('pomo-break-min'))el('pomo-break-min').value=state.userSettings.pomoBreak}save();updateTimerDisplay()}
    function startPomoWork(){const cat=el('timer-category').value.trim();if(!cat){showMessage("分野を入力してください");el('timer-category').focus();return;}const timer=state.timers.pomodoro,baseMin=parseInt(el('pomo-work-min').value)||state.userSettings.pomoWork,overtime=(state.userSettings.autoAddOvertime&&timer.overtime)?timer.overtime:0;timer.remaining=(baseMin*60)+overtime;timer.state='work';timer.isRunning=!0;timer.overtime=0;if(overtime>0)showMessage(`休憩超過 ${formatTime(overtime,!1)} を勉強時間に追加しました`);else showMessage("勉強スタート！");updateTimerDisplay()}
    function startPomoBreak(){const timer=state.timers.pomodoro,breakMin=parseInt(el('pomo-break-min').value)||state.userSettings.pomoBreak;timer.remaining=breakMin*60;timer.state='break';timer.isRunning=!0;showMessage("休憩スタート！");updateTimerDisplay()}
    function toggleProblemTimer(){const btn=el('problem-timer-btn'),limitInput=el('problem-timer-limit'),limitMin=parseFloat(limitInput.value)||0;if(state.problemTimer.isRunning){clearInterval(state.problemTimerInterval);state.problemTimer.isRunning=!1;btn.innerHTML='<i class="fas fa-play mr-2"></i>計測開始';btn.className="bg-sky-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm active:bg-sky-600";limitInput.disabled=!1}else{state.problemTimer.isRunning=!0;btn.innerHTML='<i class="fas fa-pause mr-2"></i>停止';btn.className="bg-orange-400 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm";limitInput.disabled=!0;state.problemTimerInterval=setInterval(()=>{state.problemTimer.elapsed++;const elapsed=state.problemTimer.elapsed;elements.problemTimerDisplay.innerText=formatTime(elapsed,!1);const countdownEl=el('problem-countdown-display');if(limitMin>0){const limitSec=limitMin*60,remaining=limitSec-elapsed;if(remaining>=0){countdownEl.innerText="あと "+formatTime(remaining,!1);countdownEl.className="text-xs font-mono font-bold text-sky-500"}else{countdownEl.innerText="超過 "+formatTime(Math.abs(remaining),!1);countdownEl.className="text-xs font-mono font-bold text-rose-500"}}else{countdownEl.innerText="--:--";countdownEl.className="text-xs font-mono font-bold text-slate-300"}},1000)}}
    function updateCountdownDisplay(){const limitMin=parseFloat(el('problem-timer-limit').value)||0,countdownEl=el('problem-countdown-display');if(limitMin>0&&state.problemTimer.elapsed===0){countdownEl.innerText="あと "+formatTime(limitMin*60,!1);countdownEl.className="text-xs font-mono font-bold text-slate-400"}else if(state.problemTimer.elapsed===0){countdownEl.innerText="--:--";countdownEl.className="text-xs font-mono font-bold text-slate-300"}}
    function resetProblemTimerDisplay(){if(!state.problemTimer.isRunning){const limitMin=parseFloat(el('problem-timer-limit').value)||0;elements.problemTimerDisplay.classList.remove('text-red-500');if(limitMin>0&&state.problemTimer.elapsed===0)updateCountdownDisplay();else if(state.problemTimer.elapsed===0){elements.problemTimerDisplay.innerText="00:00";updateCountdownDisplay()}}}
    function getUniqueProblems(){const map={};state.logs.filter(l=>l.type==='evaluation').forEach(l=>{const k=`${l.subject}:${l.book}:${l.category}:${l.problemNo}`;if(!map[k]||new Date(l.timestamp)>new Date(map[k].timestamp))map[k]=l});return Object.values(map).sort((a,b)=>parseInt(a.problemNo)-parseInt(b.problemNo))}
    function seekNextProblem(){const currentNo=parseInt(el('input-problem-no').value)||0;const filter=el('eval-filter').value;const allProblems=getUniqueProblems();const sub=el('input-subject').value.trim();const book=el('input-book').value.trim();const cat=el('input-category').value.trim();const next=allProblems.find(p=>{if((sub!==""&&p.subject!==sub)||(book!==""&&p.book!==book)||(cat!==""&&p.category!==cat))return false;const pNo=parseInt(p.problemNo);if(pNo<=currentNo)return false;if(filter==='all')return true;const lv=p.level;if(filter==='le4')return lv&&lv<=4;if(filter==='le3')return lv&&lv<=3;if(filter==='le2')return lv&&lv<=2;if(filter==='le1')return lv===1;return true});if(next){el('input-subject').value=next.subject;el('input-book').value=next.book;el('input-category').value=next.category;el('input-problem-no').value=next.problemNo;updateLastLapDisplay();showMessage(`No.${next.problemNo} に移動しました`)}else{showMessage("条件に一致する次の問題はありません")}}
    function recordEvaluation(lv){const sub=el('input-subject').value.trim()||"その他",book=el('input-book').value.trim()||"その他",cat=el('input-category').value.trim(),no=el('input-problem-no').value,duration=state.problemTimer.elapsed;state.logs.push({id:Date.now(),subject:sub,book:book,category:cat,problemNo:no,level:lv,timestamp:new Date().toISOString(),type:'evaluation',duration:duration});['subjects','books','categories'].forEach((key,i)=>{const v=[sub,book,cat][i];if(v&&!state.history[key].includes(v))state.history[key].push(v)});if(state.problemTimer.isRunning)toggleProblemTimer();state.problemTimer.elapsed=0;elements.problemTimerDisplay.innerText="00:00";resetProblemTimerDisplay();if(el('eval-filter').value!=='all'){seekNextProblem()}else{el('input-problem-no').value=parseInt(no)+1;updateLastLapDisplay()}if(cat){const catKey=sub+':'+cat;state.categoryTimeRecords[catKey]=(state.categoryTimeRecords[catKey]||0)+duration;}save();refreshUI()}
    function submitManualTime(){const sub=el('manual-subject').value.trim()||"その他",cat=el('manual-category').value.trim(),min=parseInt(el('manual-minutes').value)||0,dateStr=el('manual-date').value,timeStr=el('manual-start-time').value;if(!dateStr||!min)return showMessage("入力内容を確認してください");let stT=timeStr;if(!stT){const n=new Date();stT=`${pad(n.getHours())}:${pad(n.getMinutes())}`}const dur=min*60,startDateTime=new Date(`${dateStr}T${stT}`);state.logs.push({id:Date.now(),subject:sub,category:cat,manualDuration:dur,type:'manual',timestamp:startDateTime.toISOString()});state.timeRecords[dateStr]=(state.timeRecords[dateStr]||0)+dur;state.subjectTimeRecords[sub]=(state.subjectTimeRecords[sub]||0)+dur;if(cat){const catKey=sub+':'+cat;state.categoryTimeRecords[catKey]=(state.categoryTimeRecords[catKey]||0)+dur;}if(!state.history.subjects.includes(sub))state.history.subjects.push(sub);if(cat&&!state.history.categories.includes(cat))state.history.categories.push(cat);let cur=new Date(startDateTime),rem=dur;while(rem>0){const dS=cur.toISOString().split('T')[0],cH=cur.getHours(),nH=new Date(cur);nH.setHours(cH+1,0,0,0);const diff=(nH-cur)/1000,cons=Math.min(rem,diff);if(!state.hourlyRecords[dS])state.hourlyRecords[dS]=new Array(24).fill(0);state.hourlyRecords[dS][cH]+=cons;rem-=cons;cur=nH}save();refreshUI();el('manual-minutes').value='';showMessage("記録しました")}
    function updateLastLapDisplay(){const subInput=el('input-subject').value.trim();const bookInput=el('input-book').value.trim();const sub=subInput||"その他";const book=bookInput||"その他";const cat=el('input-category').value.trim();const no=el('input-problem-no').value;const lastLog=state.logs.slice().reverse().find(l=>l.type==='evaluation'&&l.subject===sub&&l.book===book&&l.category===cat&&l.problemNo==no);const prevBadge=el('prev-eval-badge');const prevTime=el('prev-time-badge');const colors={1:'bg-red-100 text-red-600',2:'bg-orange-100 text-orange-600',3:'bg-yellow-100 text-yellow-600',4:'bg-green-100 text-green-600',5:'bg-blue-100 text-blue-600'};if(lastLog&&lastLog.level){prevBadge.innerText=`Lv.${lastLog.level}`;prevBadge.className=`text-[10px] font-bold px-2 py-0.5 rounded ${colors[lastLog.level]}`}else{prevBadge.innerText="--";prevBadge.className="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded"}if(lastLog&&lastLog.duration!==undefined){prevTime.innerText=formatTime(lastLog.duration,!1);const targetSec=lastLog.duration*0.9;if(!state.problemTimer.isRunning && el('problem-timer-limit').value === ""){el('problem-timer-limit').value=(targetSec/60).toFixed(1);updateCountdownDisplay()}}else{prevTime.innerText="--:--";}}
    function renderReviewList(){if(!elements.reviewList)return;const typeF=el('list-filter-type').value,lvF=el('list-filter-level').value,subF=el('list-filter-subject').value,catF=el('list-filter-category').value,subjects=[...new Set(state.logs.map(l=>l.subject))].sort(),categories=[...new Set(state.logs.map(l=>l.category).filter(Boolean))].sort();el('list-filter-subject').innerHTML='<option value="all">全教科</option>'+subjects.map(s=>`<option value="${s}" ${s===subF?'selected':''}>${s}</option>`).join('');el('list-filter-category').innerHTML='<option value="all">全分野</option>'+categories.map(c=>`<option value="${c}" ${c===catF?'selected':''}>${c}</option>`).join('');let items=[...state.logs].reverse();if(typeF!=='all')items=items.filter(l=>l.type===typeF);if(lvF!=='all'){const lv=parseInt(lvF.slice(2));items=items.filter(l=>l.level&&l.level<=lv)}if(subF!=='all')items=items.filter(l=>l.subject===subF);if(catF!=='all')items=items.filter(l=>l.category===catF);const colors=['','text-red-500 bg-red-50','text-orange-500 bg-orange-50','text-yellow-600 bg-yellow-50','text-green-500 bg-green-50','text-blue-500 bg-blue-50'];elements.reviewList.innerHTML=items.length?items.map(l=>`<div onclick="openEdit(${l.id})" class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl shadow-sm active:bg-slate-50 transition-colors"><div class="overflow-hidden"><p class="text-[8px] text-slate-400 font-bold uppercase">${new Date(l.timestamp).toLocaleDateString()}</p><p class="text-xs font-bold text-slate-700 truncate">${l.subject} ${l.problemNo?'No.'+l.problemNo:''}</p>${l.category?`<p class="text-[9px] text-slate-400">${l.category}</p>`:''}</div>${l.level?`<span class="text-[9px] font-bold px-2 py-1 rounded-lg ${colors[l.level]} whitespace-nowrap">Lv.${l.level}</span>`:`<span class="text-[9px] font-bold px-2 py-1 rounded-lg bg-emerald-50 text-emerald-600 whitespace-nowrap">${Math.floor(l.manualDuration/60)}分</span>`}</div>`).join(''):'<p class="text-xs text-slate-300 text-center py-10">履歴はありません</p>'}
    function updatePrioritySuggestions(){const list = el('priority-list');const emptyMsg = el('priority-empty-msg');if (!list) return;const aggregation = {};for (const key in state.categoryTimeRecords) {const [sub, cat] = key.split(':');if (!aggregation[key]) {aggregation[key] = { subject: sub, category: cat, totalTime: state.categoryTimeRecords[key], levels: [] };} else {aggregation[key].totalTime = state.categoryTimeRecords[key];}}state.logs.forEach(log => {if (!log.subject || !log.category || !log.level) return;const key = log.subject + ':' + log.category;if (!aggregation[key]) {aggregation[key] = { subject: log.subject, category: log.category, totalTime: 0, levels: [] };}aggregation[key].levels.push(log.level);});const items = Object.values(aggregation);if (items.length === 0) {list.innerHTML = '';emptyMsg.classList.remove('hidden');return;}emptyMsg.classList.add('hidden');const totalGlobalTime = items.reduce((acc, i) => acc + i.totalTime, 0);const avgGlobalTime = items.length > 0 ? totalGlobalTime / items.length : 0;const prioritizedItems = items.map(item => {const avgLevel = item.levels.length > 0 ? item.levels.reduce((a, b) => a + b, 0) / item.levels.length : 0; let priorityScore = 0;let reason = "";let reasonType = "medium"; if (avgLevel >= 4.0) {priorityScore = -100;} else if (item.totalTime > avgGlobalTime * 1.2 && avgLevel < 3.0 && avgLevel > 0) {priorityScore = 100 + (item.totalTime / 60); reason = "時間の割に理解が低い";reasonType = "high";}else if (item.totalTime < avgGlobalTime * 0.5 && avgLevel < 3.0) {priorityScore = 80 + (5 - (avgLevel || 1)) * 10;reason = "学習不足";reasonType = "high";}else if (avgLevel < 2.5 && avgLevel > 0) {priorityScore = 60 + (item.totalTime / 60);reason = "効率が悪い";reasonType = "medium";}else {priorityScore = (5 - (avgLevel || 2.5)) * 10;reason = "理解度強化が必要";reasonType = "medium";}return { ...item, priorityScore, reason, reasonType };}).filter(item => item.priorityScore > 0).sort((a, b) => b.priorityScore - a.priorityScore).slice(0, 3); if (prioritizedItems.length === 0) {list.innerHTML = '<p class="text-[10px] text-slate-400 text-center py-2">現在、優先して取り組むべき課題は見つかりませんでした。</p>';return;}list.innerHTML = prioritizedItems.map(item => `<div class="priority-item ${item.reasonType === 'high' ? 'priority-high' : 'priority-medium'} p-2 rounded-r-lg mb-1 flex justify-between items-center shadow-sm"><div><div class="flex items-baseline gap-2"><span class="text-xs font-bold text-slate-700">${item.subject}</span><span class="text-[10px] text-slate-500">${item.category}</span></div></div><span class="text-[9px] font-bold ${item.reasonType === 'high' ? 'text-rose-500' : 'text-orange-500'} bg-white px-2 py-1 rounded-full border border-slate-100 shadow-sm">${item.reason}</span></div>`).join('');}
    function openEdit(id){state.editingId=id;const l=state.logs.find(x=>x.id===id);if(!l)return;el('edit-info').innerText=`${l.subject} の記録`;el('evaluation-edit-panel').classList.toggle('hidden',l.type==='manual');el('edit-modal').classList.add('active')}
    function closeModal(){el('edit-modal').classList.remove('active')}
    function updateLog(lv){const i=state.logs.findIndex(x=>x.id===state.editingId);if(i!==-1){state.logs[i].level=lv;save();refreshUI()}closeModal()}
    function requestDeleteLog(){const logToDelete=state.logs.find(x=>x.id===state.editingId);if(!logToDelete)return;if(logToDelete.type==='manual'){const dateStr=new Date(logToDelete.timestamp).toISOString().split('T')[0],dur=logToDelete.manualDuration||0;if(state.timeRecords[dateStr])state.timeRecords[dateStr]=Math.max(0,state.timeRecords[dateStr]-dur);if(state.subjectTimeRecords[logToDelete.subject])state.subjectTimeRecords[logToDelete.subject]=Math.max(0,state.subjectTimeRecords[logToDelete.subject]-dur);if(logToDelete.category){const catKey=logToDelete.subject+':'+logToDelete.category;state.categoryTimeRecords[catKey]=Math.max(0,(state.categoryTimeRecords[catKey]||0)-dur);}}state.logs=state.logs.filter(x=>x.id!==state.editingId);save();refreshUI();closeModal();showMessage("削除しました")}
    function setGoalScope(s){state.goalScope=s;el('goal-toggle-day').className=s==='day'?'active':'inactive';el('goal-toggle-week').className=s==='week'?'active':'inactive';el('goal-toggle-month').className=s==='month'?'active':'inactive';save();refreshUI()}
    function saveDailyGoal(){const val=parseFloat(el('input-daily-goal').value)||0;if(state.goalScope==='day')state.dailyGoalSec=val*3600;else if(state.goalScope==='week')state.weeklyGoalSec=val*3600;else state.monthlyGoalSec=val*3600;save();refreshUI();el('input-daily-goal').value=""}
    function openGoalModal(id=null){state.editingGoalId=id;const titleEl=el('goal-modal-title'),btnEl=el('goal-save-btn'),delBtn=el('goal-delete-btn');if(id){const target=state.goals.find(g=>g.id===id);if(target){el('goal-title').value=target.title;el('goal-target').value=target.targetSec/3600;titleEl.innerText="目標を編集";btnEl.innerText="更新";delBtn.classList.remove('hidden')}}else{el('goal-title').value='';el('goal-target').value='';titleEl.innerText="新しい学習目標";btnEl.innerText="保存";delBtn.classList.add('hidden')}el('goal-modal').classList.add('active')}
    function closeGoalModal(){el('goal-modal').classList.remove('active')}
    function saveGoalEntry(){const t=el('goal-title').value.trim(),target=parseInt(el('goal-target').value)||0;if(t&&target>0){if(state.editingGoalId){const index=state.goals.findIndex(g=>g.id===state.editingGoalId);if(index!==-1){state.goals[index].title=t;state.goals[index].targetSec=target*3600;showMessage("目標を更新しました")}}else{state.goals.push({id:Date.now(),title:t,targetSec:target*3600});showMessage("目標を追加しました")}save();refreshUI();closeGoalModal()}else showMessage("教科と時間を入力してください")}
    function deleteGoalFromModal(){if(state.editingGoalId){closeGoalModal();confirmDeleteGoal(state.editingGoalId)}}
    function confirmDeleteGoal(id){showConfirm("目標を削除","この目標を削除しますか？",()=>{state.goals=state.goals.filter(g=>g.id!==id);save();refreshUI()})}
    function renderGoals(){elements.goalList.innerHTML=state.goals.map(g=>{const total=state.subjectTimeRecords[g.title]||0,progress=Math.min(100,(total/g.targetSec)*100);return `<div class="space-y-2 cursor-pointer hover:bg-slate-50 p-2 -mx-2 rounded-lg transition-colors" onclick="openGoalModal(${g.id})"><div class="flex justify-between items-end"><span class="text-[10px] font-bold text-slate-500">${g.title}</span><div class="flex gap-2 items-center"><span class="text-[10px] font-bold text-indigo-500">${Math.round(progress)}%</span></div></div><div class="goal-progress-bar"><div class="goal-progress-fill" style="width: ${progress}%"></div></div></div>`}).join('')||'<p class="text-[10px] text-slate-300 text-center py-4">教科別の目標はありません</p>';const target=state.goalScope==='day'?state.dailyGoalSec:(state.goalScope==='week'?state.weeklyGoalSec:state.monthlyGoalSec);elements.dailyGoalValue.innerText=target>0?`${(target/3600).toFixed(1)} 時間`:"-- 時間";const goalLabelMap={day:"今日の目標",week:"今週の目標",month:"今月の目標"};el('goal-setting-label').innerText=goalLabelMap[state.goalScope]||"目標";}
    function renderExam(){const list=el('exam-list-container');if(!state.exams||state.exams.length===0){list.innerHTML='<p class="text-xs text-slate-300 text-center py-2">試験は登録されていません</p>';return}list.innerHTML=state.exams.map(e=>{const diff=Math.ceil((new Date(e.date)-new Date().setHours(0,0,0,0))/(1e3*60*60*24));return `<div onclick="showExamForm(${e.id})" class="flex justify-between items-center bg-rose-50 p-3 rounded-xl border border-rose-100 cursor-pointer hover:bg-rose-100 transition-colors"><div><p class="text-xs font-bold text-rose-600">${e.name}</p><p class="text-[9px] text-rose-400">${e.date.replace(/-/g,'/')}</p></div><div class="flex items-baseline gap-1"><span class="text-[10px] text-slate-400 font-bold">あと</span><span class="text-2xl font-black text-rose-500">${diff>=0?diff:"終了"}</span><span class="text-xs font-bold text-rose-600">日</span></div></div>`}).join('')}
    function showExamForm(id=null){state.editingExamId=id;const area=el('exam-input-area');const delBtn=el('btn-delete-exam');const title=el('exam-form-title');area.classList.remove('hidden');if(id){const t=state.exams.find(e=>e.id===id);if(t){el('input-exam-name').value=t.name;el('input-exam-date').value=t.date;title.innerText="試験を編集";delBtn.classList.remove('hidden')}}else{el('input-exam-name').value='';el('input-exam-date').value='';title.innerText="新しい試験を追加";delBtn.classList.add('hidden')}}
    function hideExamForm(){el('exam-input-area').classList.add('hidden');state.editingExamId=null}
    function saveExam(){const n=el('input-exam-name').value,d=el('input-exam-date').value;if(n&&d){if(state.editingExamId){const idx=state.exams.findIndex(e=>e.id===state.editingExamId);if(idx!==-1){state.exams[idx].name=n;state.exams[idx].date=d;showMessage("試験を更新しました")}}else{state.exams.push({id:Date.now(),name:n,date:d});showMessage("試験を追加しました")}save();renderExam();hideExamForm()}}
    function deleteExam(){if(state.editingExamId){showConfirm("試験を削除","この試験データを削除しますか？",()=>{state.exams=state.exams.filter(e=>e.id!==state.editingExamId);save();renderExam();hideExamForm();showMessage("削除しました")})}}
    function editExam(){el('exam-display-area').classList.add('hidden');el('exam-input-area').classList.remove('hidden')}
    function addTodo(){const t=elements.todoInput.value.trim();if(t){state.todos.push({id:Date.now(),text:t,completed:!1});elements.todoInput.value='';save();renderTodos()}}
    function toggleTodo(id){const t=state.todos.find(x=>x.id===id);if(t){t.completed=!t.completed;save();renderTodos()}}
    function deleteTodo(id){state.todos=state.todos.filter(x=>x.id!==id);save();renderTodos()}
    function confirmClearTodos(){if(state.todos.some(t=>t.completed))showConfirm("完了分を削除","完了したタスクを削除してもよろしいですか？",()=>{state.todos=state.todos.filter(t=>!t.completed);save();renderTodos()})}
    function renderTodos(){elements.todoContainer.innerHTML=state.todos.map(t=>`<div class="todo-item ${t.completed?'completed':''}"><div class="todo-check ${t.completed?'active':''}" onclick="toggleTodo(${t.id})"></div><span class="flex-grow text-sm font-medium text-slate-700">${t.text}</span><button onclick="deleteTodo(${t.id})" class="text-slate-300 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt text-xs"></i></button></div>`).join('')||'<p class="text-[10px] text-slate-300 text-center py-4">タスクはありません</p>'}
    function setCalendarMode(m){state.calendarMode=m;el('calendar-month-view').classList.toggle('hidden',m!='month');el('calendar-week-view').classList.toggle('hidden',m!='week');el('mode-month-btn').className=m=='month'?'active':'inactive';el('mode-week-btn').className=m=='week'?'active':'inactive';refreshUI()}
    function changeCalendarView(d,m){if(m=='month')state.viewDate.setMonth(state.viewDate.getMonth()+d);else state.viewDate.setDate(state.viewDate.getDate()+d);refreshUI()}
    function renderMonthCalendar(){const container=el('calendar-grid');container.innerHTML='';const y=state.viewDate.getFullYear(),m=state.viewDate.getMonth();el('calendar-month-label').innerText=`${y}年${m+1}月`;['日','月','火','水','木','金','土'].forEach(d=>container.innerHTML+=`<div class="text-[9px] text-center text-slate-300 font-bold">${d}</div>`);const f=new Date(y,m,1).getDay(),l=new Date(y,m+1,0).getDate();for(let i=0;i<f;i++)container.innerHTML+='<div></div>';for(let d=1;d<=l;d++){const ds=`${y}-${pad(m+1)}-${pad(d)}`,heat=state.timeRecords[ds]?Math.min(4,Math.floor(state.timeRecords[ds]/3600)+1):0;container.innerHTML+=`<div class="day-cell heat-${heat} text-slate-400 font-bold">${d}</div>`}}
    function renderWeekCalendar(){const base=new Date(state.viewDate),idx=base.getDay(),ds=[0,1,2,3,4,5,6].map(i=>{const d=new Date(base);d.setDate(base.getDate()+(i-idx));return d.toISOString().split('T')[0]});el('calendar-week-label').innerText=`${ds[0].slice(5)} ~ ${ds[6].slice(5)}`;let max=3600;ds.forEach(d=>max=Math.max(max,state.timeRecords[d]||0));
    const container=el('week-view-container');
    container.innerHTML=['sun','mon','tue','wed','thu','fri','sat'].map((d,i)=>{
        const sec=state.timeRecords[ds[i]]||0;
        const dateObj=new Date(ds[i]),jdays=['日','月','火','水','木','金','土'];
        const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),timeText=(h>0?`${h}h`:'')+`${m}m`;
        return `<div class="flex flex-col items-center gap-1 group cursor-default">
            <div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative">
                <div class="week-bar-fill w-full absolute bottom-0" style="height:${(sec/max)*100}%"></div>
            </div>
            <div class="text-center">
                <div class="text-[9px] font-bold ${ds[i]===getTodayStr()?'text-sky-500':'text-slate-400'} leading-tight">${dateObj.getDate()}(${jdays[i]})</div>
                <div class="text-[9px] font-bold ${sec>0?'text-slate-600':'text-slate-300'} leading-tight">${sec>0?timeText:'--'}</div>
            </div>
        </div>`;
    }).join('');
    const tl=el('timeline-container');tl.innerHTML='';for(let h=0;h<24;h++){tl.innerHTML+=`<div class="timeline-time-label">${h}</div>`;ds.forEach(d=>{const heat=state.hourlyRecords[d]?.[h]?Math.min(4,Math.floor(state.hourlyRecords[d][h]/900)+1):0;tl.innerHTML+=`<div class="timeline-cell hour-heat-${heat}"></div>`})}}
    let radarInst=null;
    function resetRadarMode(){state.selectedRadarSubject=null;el('btn-back-to-total').classList.add('hidden');el('radar-mode-label').innerText="全体バランス";refreshUI()}
    function selectRadarSubject(s){state.selectedRadarSubject=s;el('btn-back-to-total').classList.remove('hidden');el('radar-mode-label').innerText=s;refreshUI()}
    function renderRadar(){const subs=[...new Set(state.logs.filter(l=>l.level).map(l=>l.subject))];el('radar-subject-chips').innerHTML=subs.map(s=>`<div onclick="selectRadarSubject('${s}')" class="category-chip ${state.selectedRadarSubject===s?'active':''}">${s}</div>`).join('');let labels=[],data=[];if(state.selectedRadarSubject){const map={};state.logs.filter(l=>l.subject===state.selectedRadarSubject&&l.level).forEach(l=>{(map[l.category]=map[l.category]||[]).push(l.level)});labels=Object.keys(map);data=labels.map(c=>(map[c].reduce((a,b)=>a+b,0)/map[c].length).toFixed(1))}else{const map={};state.logs.filter(l=>l.level).forEach(l=>{(map[l.subject]=map[l.subject]||[]).push(l.level)});labels=Object.keys(map);data=labels.map(s=>(map[s].reduce((a,b)=>a+b,0)/map[s].length).toFixed(1))}if(radarInst)radarInst.destroy();if(labels.length===0)return;radarInst=new Chart(el('radarChart'),{type:'radar',data:{labels,datasets:[{data,backgroundColor:'rgba(14,165,233,0.1)',borderColor:'#0ea5e9',borderWidth:2,pointBackgroundColor:'#0ea5e9'}]},options:{scales:{r:{min:0,max:5,ticks:{display:!1,stepSize:1},grid:{color:'#f1f5f9'}}},plugins:{legend:{display:!1}}}})}
    function renderSubjectTime(){const sorted=Object.keys(state.subjectTimeRecords).sort((a,b)=>state.subjectTimeRecords[b]-state.subjectTimeRecords[a]),maxTime=sorted.length>0?state.subjectTimeRecords[sorted[0]]:1;elements.subjectTimeList.innerHTML=sorted.map(s=>{const time=state.subjectTimeRecords[s],widthPercent=(time/maxTime)*100,hours=Math.floor(time/3600),mins=Math.floor((time%3600)/60);return `<div class="space-y-1"><div class="flex justify-between items-end"><span class="text-xs font-bold text-slate-700">${s}</span><span class="text-[10px] font-bold text-sky-600">${hours>0?hours+'h ':''}${mins}m</span></div><div class="subject-bar-container"><div class="subject-bar-fill" style="width: ${widthPercent}%"></div></div></div>`}).join('')||'<p class="text-xs text-slate-300 text-center py-2">学習データがありません</p>'}
    const calculateCurrentWeekTotal=(currentTodaySec)=>{const today=new Date(),todayStr=getTodayStr(),day=today.getDay(),startOfWeek=new Date(today.setDate(today.getDate()-day));let total=0;for(let i=0;i<7;i++){const d=new Date(startOfWeek);d.setDate(startOfWeek.getDate()+i);const ds=d.toISOString().split('T')[0];if(ds===todayStr&&currentTodaySec!==undefined){total+=currentTodaySec}else{total+=(state.timeRecords[ds]||0)}}return total};
    const calculateCurrentMonthTotal = (forceTodaySec) => {const todayStr = getTodayStr(); const monthPrefix = todayStr.substring(0, 7); let total = 0; Object.keys(state.timeRecords).forEach(date => {if (date.startsWith(monthPrefix)) {if (date === todayStr && forceTodaySec !== undefined) {total += forceTodaySec;} else {total += state.timeRecords[date];}}}); if (forceTodaySec !== undefined && !state.timeRecords[todayStr]) {total += forceTodaySec;} return total;};
    function updateTotalDisplay(forceTodaySec){const today=getTodayStr(),todaySec=(forceTodaySec!==undefined)?forceTodaySec:(state.timeRecords[today]||0);let currentTotal=0,label="今日";if(state.goalScope==='day'){currentTotal=todaySec;label="今日"}else if(state.goalScope==='week'){currentTotal=calculateCurrentWeekTotal(forceTodaySec);label="今週"}else{currentTotal=calculateCurrentMonthTotal(forceTodaySec);label="今月"}elements.totalTimeDisplay.innerText=`${label}: ${formatTime(currentTotal)}`;const target=state.goalScope==='day'?state.dailyGoalSec:(state.goalScope==='week'?state.weeklyGoalSec:state.monthlyGoalSec);if(target>0){const p=Math.min(100,Math.floor((currentTotal/target)*100));elements.headerGoalFill.style.width=`${p}%`;elements.headerGoalPercent.innerText=`${p}%`;elements.headerGoalText.innerText=`Goal: ${(target/3600).toFixed(1)}h`}else{elements.headerGoalFill.style.width=`0%`;elements.headerGoalPercent.innerText=`0%`;elements.headerGoalText.innerText=`Goal: 未設定`}}
    function showMessage(msg){const b=elements.msgBox;b.innerText=msg;b.style.opacity="1";setTimeout(()=>b.style.opacity="0",2500)}
    function showConfirm(t,b,onE){el('confirm-title').innerText=t;el('confirm-body').innerText=b;el('confirm-execute-btn').onclick=()=>{onE();closeConfirmModal()};el('confirm-modal').classList.add('active')}
    function closeConfirmModal(){el('confirm-modal').classList.remove('active')}
    function exportData(){const data=JSON.stringify(state),blob=new Blob([data],{type:'application/json'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=`StudyFlow_Backup_${getTodayStr()}.json`;a.click();showMessage("バックアップを作成しました")}
    function resetAllData(){showConfirm("全データの削除","これまでの記録がすべて消去されます。よろしいですか？",()=>{localStorage.clear();location.reload()})}
    window.onload=()=>{el('manual-date').valueAsDate=new Date;navigate('home')};
</script>

<script type="module">
    // Firebase App (the core Firebase SDK) is always required and must be listed first
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // プレビュー環境の設定（__firebase_config）を優先し、なければユーザーのデフォルト値を使用
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyAhDwueGffBsvD3SFicoZRGYD23SZeryOI",
    authDomain: "studyflow-2cca1.firebaseapp.com",
    projectId: "studyflow-2cca1",
    storageBucket: "studyflow-2cca1.firebasestorage.app",
    messagingSenderId: "44366511587",
    appId: "1:44366511587:web:a5099f7e4b040b74bdf4d6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'studyflow-v1';

    // Cloud Data Management
    async function loadUserData(user) {
        if (!user) return;
        
        // Use the standardized path rule: /artifacts/{appId}/users/{userId}/userData/main
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'userData', 'main');
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                // Merge cloud data into local state
                state.logs = data.logs || [];
                state.timeRecords = data.timeRecords || {};
                state.hourlyRecords = data.hourlyRecords || {};
                state.subjectTimeRecords = data.subjectTimeRecords || {};
                state.categoryTimeRecords = data.categoryTimeRecords || {};
                state.goals = data.goals || [];
                state.todos = data.todos || [];
                state.exams = data.exams || [];
                state.history = data.history || {subjects:[],books:[],categories:[]};
                state.featureSettings = data.featureSettings || state.featureSettings;
                state.userSettings = data.userSettings || state.userSettings;
                state.dailyGoalSec = data.dailyGoalSec || 0;
                state.weeklyGoalSec = data.weeklyGoalSec || 0;
                state.monthlyGoalSec = data.monthlyGoalSec || 0;
                state.goalScope = data.goalScope || 'day';
                
                // Save merged data to local storage to keep it sync
                localStorage.setItem('studyflow_logs',JSON.stringify(state.logs));
                localStorage.setItem('studyflow_time',JSON.stringify(state.timeRecords));
                localStorage.setItem('studyflow_hourly',JSON.stringify(state.hourlyRecords));
                localStorage.setItem('studyflow_subjects',JSON.stringify(state.subjectTimeRecords));
                localStorage.setItem('studyflow_categories',JSON.stringify(state.categoryTimeRecords));
                localStorage.setItem('studyflow_goals',JSON.stringify(state.goals));
                localStorage.setItem('studyflow_todos',JSON.stringify(state.todos));
                localStorage.setItem('studyflow_history',JSON.stringify(state.history));
                localStorage.setItem('studyflow_daily_goal_sec',state.dailyGoalSec);
                localStorage.setItem('studyflow_weekly_goal_sec',state.weeklyGoalSec);
                localStorage.setItem('studyflow_monthly_goal_sec',state.monthlyGoalSec);
                localStorage.setItem('studyflow_goal_scope',state.goalScope);
                localStorage.setItem('studyflow_exams',JSON.stringify(state.exams));
                localStorage.setItem('studyflow_features',JSON.stringify(state.featureSettings));
                localStorage.setItem('studyflow_user_settings',JSON.stringify(state.userSettings));
                
                StudyStats.invalidate();
                refreshUI();
                showMessage("データを同期しました");
            } else {
                // If no cloud data exists, we might want to save current local data to cloud?
                // For now, let's just say we are ready to save.
                // console.log("No cloud data found, starting fresh or local only.");
            }
        } catch (e) {
            console.error("Sync Error:", e);
            showMessage("同期エラー: " + e.message);
        }
    }

    async function saveToCloud() {
        if (!state.currentUser) return;
        
        const dataToSave = {
            logs: state.logs,
            timeRecords: state.timeRecords,
            hourlyRecords: state.hourlyRecords,
            subjectTimeRecords: state.subjectTimeRecords,
            categoryTimeRecords: state.categoryTimeRecords,
            goals: state.goals,
            todos: state.todos,
            exams: state.exams,
            history: state.history,
            featureSettings: state.featureSettings,
            userSettings: state.userSettings,
            dailyGoalSec: state.dailyGoalSec,
            weeklyGoalSec: state.weeklyGoalSec,
            monthlyGoalSec: state.monthlyGoalSec,
            goalScope: state.goalScope,
            lastUpdated: new Date().toISOString()
        };
        
        const docRef = doc(db, 'artifacts', appId, 'users', state.currentUser.uid, 'userData', 'main');
        try {
            await setDoc(docRef, dataToSave, { merge: true });
            // console.log("Saved to cloud");
        } catch (e) {
            console.error("Save Error:", e);
        }
    }

    // Expose saveToCloud to window so the main app logic can call it
    window.saveToCloud = saveToCloud;

    // 認証状態の監視
    onAuthStateChanged(auth, (user) => {
        state.currentUser = user;
        state.dbAvailable = true; // Firestore is initialized
        if (state.currentPage === 'settings') {
            renderFeatureSettings(); // 設定画面を開いている場合は再描画
        }
        
        if (user) {
            // Logged in: Load data from cloud
            loadUserData(user);
        } else {
            // Logged out
        }
    });

    // グローバル関数として公開（HTMLのonclick属性から呼ぶため）
    
    // Googleログイン
    window.handleGoogleLogin = async () => {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            showMessage("Googleでログインしました");
        } catch (error) {
            console.error("Login Error:", error);
            showMessage("ログインに失敗しました: " + error.message);
        }
    };

    // メールログイン
    window.handleEmailLogin = async () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        if (!email || !password) return showMessage("メールとパスワードを入力してください");
        
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showMessage("ログインしました");
        } catch (error) {
            console.error("Login Error:", error);
            showMessage("ログイン失敗: パスワード等が間違っています");
        }
    };

    // メール新規登録
    window.handleEmailSignup = async () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        if (!email || !password) return showMessage("メールとパスワードを入力してください");
        
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showMessage("アカウントを作成しました");
        } catch (error) {
            console.error("Signup Error:", error);
            showMessage("登録失敗: " + error.message);
        }
    };

    // ログアウト
    window.handleLogout = async () => {
        try {
            await signOut(auth);
            showMessage("ログアウトしました");
        } catch (error) {
            console.error("Logout Error:", error);
        }
    };

</script>
</body>
</html>


