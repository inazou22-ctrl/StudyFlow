<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>StudyFlow - Cloud Sync</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css"><style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');body{font-family:'Noto Sans JP',sans-serif;background-color:#f8fafc;color:#1e293b;touch-action:manipulation;overflow-x:hidden;-webkit-tap-highlight-color:transparent}.glass-card{background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);border-radius:1rem;box-shadow:0 4px 6px -1px rgb(0 0 0/0.05);position:relative;transition:transform .2s ease;overflow:hidden}.focus-mode{position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100vh!important;z-index:1000!important;margin:0!important;padding:2rem!important;border-radius:0!important;display:flex!important;flex-direction:column!important;justify-content:center!important;background:#fff!important;overflow-y:auto!important;border:none!important}.focus-mode .timer-text-large{font-size:8rem!important}.focus-mode .problem-timer-text-large{font-size:5rem!important}.focus-mode #review-list{max-height:80vh!important}.page-transition{transition:all .3s ease}.hidden-page{display:none}.quick-tag{font-size:11px;font-weight:700;padding:8px 12px;border-radius:12px;background:#fff;border:1px solid #e2e8f0;color:#0ea5e9;box-shadow:0 2px 4px rgba(0,0,0,0.02);transition:all .1s}.quick-tag:active{background:#f1f5f9;transform:translateY(1px)}.btn-main{display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.4,0,.2,1)}.btn-main:active{transform:scale(.95)}.day-cell{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;font-size:.75rem;border-radius:.25rem}.heat-0{background-color:#f1f5f9}.heat-1{background-color:#bae6fd}.heat-2{background-color:#7dd3fc}.heat-3{background-color:#38bdf8}.heat-4{background-color:#0ea5e9}.week-bar{width:100%;background-color:#f1f5f9;border-radius:999px;overflow:hidden;display:flex;flex-direction:column-reverse;height:100%;position:relative}.week-bar-fill{background:linear-gradient(to top,#0ea5e9,#38bdf8);width:100%;transition:height .5s cubic-bezier(0.4,0,0.2,1);height:0}.week-bar-container{height:6rem}.timeline-grid{display:grid;grid-template-columns:35px repeat(7,1fr);gap:3px}.timeline-time-label{font-size:9px;color:#94a3b8;text-align:right;padding-right:4px;height:14px;display:flex;align-items:center;justify-content:flex-end}.timeline-cell{height:14px;border-radius:2px;background-color:#f1f5f9}.hour-heat-1{background-color:#bae6fd}.hour-heat-2{background-color:#7dd3fc}.hour-heat-3{background-color:#38bdf8}.hour-heat-4{background-color:#0ea5e9}.subject-bar-container{background:#f1f5f9;height:8px;border-radius:4px;overflow:hidden;margin-top:4px}.subject-bar-fill{background:#0ea5e9;height:100%;border-radius:4px;transition:width .6s cubic-bezier(.16,1,.3,1)}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;visibility:hidden;opacity:0;transition:.3s}.modal.active{visibility:visible;opacity:1}.goal-progress-bar{height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden}.goal-progress-fill{height:100%;background:#0ea5e9;transition:width .3s ease}.goal-toggle,.stats-toggle{display:flex;background:#f1f5f9;padding:2px}.goal-toggle{border-radius:6px}.stats-toggle{border-radius:8px;width:fit-content}.goal-toggle button,.stats-toggle button{font-weight:700;border-radius:4px}.goal-toggle button{padding:2px 8px;font-size:9px}.stats-toggle button{padding:4px 12px;font-size:10px;border-radius:6px}.goal-toggle button.active,.stats-toggle button.active{background:#fff;color:#0ea5e9;box-shadow:0 1px 2px rgba(0,0,0,.05)}.goal-toggle button.inactive,.stats-toggle button.inactive{color:#94a3b8}.category-chip{padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;background:#f1f5f9;color:#64748b;cursor:pointer;border:1px solid transparent}.category-chip.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}.todo-item{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border:1px solid #f1f5f9;border-radius:12px;margin-bottom:8px}.todo-item.completed span{text-decoration:line-through;color:#94a3b8}.todo-check{width:20px;height:20px;border:2px solid #0ea5e9;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}.todo-check.active{background:#0ea5e9}.todo-check.active::after{content:'✓';color:#fff;font-size:12px;font-weight:700}.expand-btn{position:absolute;top:6px;right:6px;color:#94a3b8;cursor:pointer;z-index:50;width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center;transition:all .2s cubic-bezier(.4,0,.2,1);border-radius:50%;background:rgba(255,255,255,.7);backdrop-filter:blur(4px);border:1px solid rgba(226,232,240,.8);box-shadow:0 2px 4px rgba(0,0,0,0.03)}.expand-btn:hover{color:#0ea5e9;background:#fff;transform:scale(1.1);box-shadow:0 4px 10px rgba(14,165,233,.15);border-color:#e0f2fe}.expand-btn:active{transform:scale(.95)}.expand-btn svg{width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}.expand-btn .icon-compress{display:none}.expand-btn .icon-expand{display:block}.focus-mode .expand-btn .icon-expand{display:none}.focus-mode .expand-btn .icon-compress{display:block}.toggle-switch{position:relative;display:inline-block;width:44px;height:24px}.toggle-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#e2e8f0;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.slider{background-color:#0ea5e9}input:checked+.slider:before{transform:translateX(20px)}.stat-badge{background:linear-gradient(135deg,#0ea5e9,#38bdf8);color:#fff;border-radius:.75rem;padding:1rem;display:flex;flex-direction:column;align-items:center;justify-content:center}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:10px}.ai-glow{box-shadow:0 0 15px rgba(14,165,233,.2)}.mode-active-indicator{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background-color:#22c55e;border-radius:50%;border:2px solid #fff}.priority-item{border-left:3px solid transparent}.priority-high{border-left-color:#f43f5e;background:#fff1f2}.priority-medium{border-left-color:#f97316;background:#fff7ed}</style></head><body class="pb-32"><datalist id="list-subjects"></datalist><datalist id="list-books"></datalist><datalist id="list-categories"></datalist><header class="bg-white sticky top-0 z-50 shadow-sm px-4 py-2" id="main-header"><div class="flex justify-between items-center mb-1"><h1 class="text-lg font-bold text-sky-600 flex items-center"><i class="fas fa-layer-group mr-2"></i>StudyFlow</h1><div class="flex items-center gap-3"><div class="goal-toggle"><button id="goal-toggle-day" onclick="setGoalScope('day')" class="active">今日</button><button id="goal-toggle-week" onclick="setGoalScope('week')" class="inactive">今週</button><button id="goal-toggle-month" onclick="setGoalScope('month')" class="inactive">今月</button></div><div id="total-time-display" class="text-[10px] font-bold text-slate-500">今日: 00:00:00</div></div></div><div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div id="header-goal-fill" class="h-full bg-sky-400 transition-all duration-500 w-0"></div></div><div class="flex justify-between mt-1"><span id="header-goal-text" class="text-[9px] font-bold text-slate-400 uppercase">Goal: --</span><span id="header-goal-percent" class="text-[9px] font-bold text-sky-500">0%</span></div></header><main class="max-w-md mx-auto p-4" id="main-content"><div id="page-home" class="page-transition space-y-6"><section id="section-timer" class="glass-card p-6 text-center border-l-4 border-sky-400"><button onclick="toggleFocus('section-timer')" class="expand-btn" id="btn-expand-section-timer"><svg class="icon-expand" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></svg><svg class="icon-compress" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg></button><div class="flex justify-center space-x-2 mb-6"><button onclick="setTimerMode('stopwatch')" id="btn-stopwatch" class="relative text-xs px-4 py-1.5 rounded-full bg-sky-100 text-sky-600 font-bold transition-all">ストップウォッチ<span id="ind-stopwatch" class="hidden mode-active-indicator"></span></button><button onclick="setTimerMode('timer')" id="btn-timer" class="relative text-xs px-4 py-1.5 rounded-full bg-gray-100 text-gray-500 transition-all">タイマー<span id="ind-timer" class="hidden mode-active-indicator"></span></button><button onclick="setTimerMode('pomodoro')" id="btn-pomodoro" class="relative text-xs px-4 py-1.5 rounded-full bg-gray-100 text-gray-500 transition-all">ポモドーロ<span id="ind-pomodoro" class="hidden mode-active-indicator"></span></button></div><div class="grid grid-cols-2 gap-3 mb-6"><div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1">教科 (必須)</label><input type="text" id="timer-subject" list="list-subjects" placeholder="教科を入力" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-center outline-none focus:border-sky-300 transition-colors"></div><div><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1">分野 (必須)</label><input type="text" id="timer-category" list="list-categories" placeholder="分野を入力" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-center outline-none focus:border-sky-300 transition-colors"></div></div><div id="timer-display" class="text-6xl font-mono font-bold text-slate-700 tabular-nums tracking-tight mb-6 timer-text-large">00:00:00</div><div id="pomodoro-setting-panel" class="hidden mb-4 p-3 bg-sky-50 rounded-xl grid grid-cols-2 gap-4"><div><label class="block text-[10px] font-bold text-sky-600 mb-1">集中 (分)</label><input type="number" id="pomo-work-min" value="25" onchange="updatePomodoroWorkTime()" class="w-full text-center text-sm font-bold bg-white border border-sky-100 rounded p-1"></div><div><label class="block text-[10px] font-bold text-sky-600 mb-1">休憩 (分)</label><input type="number" id="pomo-break-min" value="5" onchange="updatePomodoroBreakTime()" class="w-full text-center text-sm font-bold bg-white border border-sky-100 rounded p-1"></div></div><div id="quick-adjust-panel" class="hidden mb-4 flex justify-center flex-wrap gap-2"><button onclick="adjustTime(1800)" class="quick-tag">+30分</button><button onclick="adjustTime(600)" class="quick-tag">+10分</button><button onclick="adjustTime(60)" class="quick-tag">+1分</button><button onclick="adjustTime(-60)" class="quick-tag text-slate-400">-1分</button></div><div class="flex justify-center items-center gap-6"><button onclick="resetTimer()" class="w-16 h-16 bg-slate-50 text-slate-400 rounded-2xl flex flex-col items-center justify-center border border-slate-100 hover:bg-slate-100 transition-colors"><i class="fas fa-undo-alt text-lg mb-1"></i><span class="text-[10px] font-bold">リセット</span></button><button id="timer-toggle" onclick="toggleTimer()" class="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg flex flex-col items-center justify-center"><i class="fas fa-play text-xl mb-1"></i><span id="timer-toggle-label" class="text-xs font-bold uppercase">学習開始</span></button><div class="w-16"></div></div><div id="pomo-sub-actions" class="hidden mt-4 text-center"></div><p id="timer-status" class="mt-4 text-[10px] text-slate-400 font-bold uppercase tracking-widest">Ready to Study</p></section><section id="section-eval" class="glass-card p-5 border-l-4 border-sky-400"><button onclick="toggleFocus('section-eval')" class="expand-btn" id="btn-expand-section-eval"><svg class="icon-expand" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></svg><svg class="icon-compress" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg></button><h2 class="font-bold flex items-center text-slate-600 text-sm mb-4"><i class="fas fa-pen-nib mr-2 text-sky-500"></i>例題評価</h2><div class="bg-slate-50 rounded-xl p-3 mb-4 border border-slate-100"><div class="flex justify-between items-center mb-2"><div class="flex flex-col"><span class="text-[10px] text-slate-400 font-bold uppercase">Time</span><span id="problem-timer-display" class="text-3xl font-mono font-bold text-slate-700 leading-none tabular-nums problem-timer-text-large">00:00</span></div><button id="problem-timer-btn" onclick="toggleProblemTimer()" class="bg-sky-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm active:bg-sky-600"><i id="problem-timer-icon" class="fas fa-play mr-2"></i>計測開始</button></div><div class="flex items-center justify-between border-t border-slate-200 pt-2"><div class="flex items-center gap-2"><label class="flex items-center text-[10px] font-bold text-slate-500 cursor-pointer"><i class="fas fa-bell mr-1 text-sky-400"></i>制限</label><input type="number" id="problem-timer-limit" placeholder="0" class="w-12 bg-white border border-slate-200 rounded p-1 text-center text-xs font-bold focus:border-sky-400 outline-none" min="0" step="0.1" onchange="updateCountdownDisplay()"><span class="text-[10px] font-bold text-slate-400">分</span></div><span id="problem-countdown-display" class="text-xs font-mono font-bold text-slate-300">--:--</span></div></div><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" id="input-subject" list="list-subjects" placeholder="教科" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none focus:border-sky-300" oninput="updateLastLapDisplay()"><input type="text" id="input-book" list="list-books" placeholder="教材" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none focus:border-sky-300" oninput="updateLastLapDisplay()"></div><input type="text" id="input-category" list="list-categories" placeholder="分野 (例: 微分積分)" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none mb-3 focus:border-sky-300" oninput="updateLastLapDisplay()"><div class="flex items-center justify-between mb-4"><div class="flex items-center space-x-2"><span class="text-xs font-bold text-slate-400">No.</span><input type="number" id="input-problem-no" value="1" class="w-20 bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-center outline-none" oninput="updateLastLapDisplay()"></div><div id="last-lap-hint" class="text-[9px] text-slate-400 font-medium bg-slate-100 px-2 py-1 rounded">前回: --:--</div></div><div class="grid grid-cols-5 gap-2"><button onclick="recordEvaluation(1)" class="bg-red-50 text-red-600 p-3 rounded-xl flex flex-col items-center hover:bg-red-100 active:scale-95 transition-all"><span class="text-lg font-bold">1</span><span class="text-[8px] font-bold">不明</span></button><button onclick="recordEvaluation(2)" class="bg-orange-50 text-orange-600 p-3 rounded-xl flex flex-col items-center hover:bg-orange-100 active:scale-95 transition-all"><span class="text-lg font-bold">2</span><span class="text-[8px] font-bold">不安</span></button><button onclick="recordEvaluation(3)" class="bg-yellow-50 text-yellow-600 p-3 rounded-xl flex flex-col items-center hover:bg-yellow-100 active:scale-95 transition-all"><span class="text-lg font-bold">3</span><span class="text-[8px] font-bold">普通</span></button><button onclick="recordEvaluation(4)" class="bg-green-50 text-green-500 p-3 rounded-xl flex flex-col items-center hover:bg-green-100 active:scale-95 transition-all"><span class="text-lg font-bold">4</span><span class="text-[8px] font-bold">理解</span></button><button onclick="recordEvaluation(5)" class="bg-blue-50 text-blue-500 p-3 rounded-xl flex flex-col items-center hover:bg-blue-100 active:scale-95 transition-all"><span class="text-lg font-bold">5</span><span class="text-[8px] font-bold">完璧</span></button></div></section><section id="section-manual" class="glass-card p-5 border-l-4 border-emerald-400"><h2 class="font-bold flex items-center text-slate-600 text-sm mb-4"><i class="fas fa-plus-circle mr-2 text-emerald-500"></i>勉強時間を記録</h2><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" id="manual-subject" list="list-subjects" placeholder="教科 (例: 英語)" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none"><input type="text" id="manual-category" list="list-categories" placeholder="分野 (例: 文法)" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm outline-none"></div><div class="flex items-center bg-slate-50 border border-slate-100 rounded-lg px-2 mb-3"><input type="number" id="manual-minutes" placeholder="分入力" class="w-full bg-transparent p-2 text-sm outline-none text-right"><span class="text-[10px] font-bold text-slate-400 ml-1">分</span></div><div class="flex items-center gap-2 mb-3"><input type="date" id="manual-date" class="flex-grow bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-slate-500"><input type="time" id="manual-start-time" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm text-slate-500 w-24"></div><button onclick="submitManualTime()" class="w-full bg-emerald-500 text-white py-3 rounded-lg text-xs font-bold shadow-sm active:bg-emerald-600 flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> 記録を保存</button></section><section id="section-review" class="glass-card p-4 border-l-4 border-slate-400"><button onclick="toggleFocus('section-review')" class="expand-btn" id="btn-expand-section-review"><svg class="icon-expand" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></svg><svg class="icon-compress" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg></button><div class="flex flex-col space-y-3 mb-4"><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">復習・全履歴</p><div class="grid grid-cols-2 gap-2"><select id="list-filter-type" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全種類</option><option value="evaluation">評価</option><option value="manual">手動</option></select><select id="list-filter-level" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全Lv</option><option value="le1">Lv.1以下</option><option value="le2">Lv.2以下</option><option value="le3">Lv.3以下</option><option value="le4">Lv.4以下</option></select><select id="list-filter-subject" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全教科</option></select><select id="list-filter-category" onchange="renderReviewList()" class="w-full text-[10px] bg-slate-50 border border-slate-100 font-bold text-slate-500 rounded px-2 py-2"><option value="all">全分野</option></select></div></div><div id="review-list" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1"></div></section></div><div id="page-analytics" class="page-transition hidden-page space-y-6"><div id="section-priority" class="glass-card p-5 border-l-4 border-sky-400 ai-glow relative overflow-hidden"><div class="absolute -right-4 -top-4 opacity-10"><i class="fas fa-sort-amount-up text-6xl text-sky-500"></i></div><div class="flex items-center gap-2 mb-3"><div class="bg-sky-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px]"><i class="fas fa-list-ol"></i></div><p class="text-xs font-bold text-slate-600 uppercase tracking-widest">優先度</p></div><div id="priority-list" class="space-y-2 relative z-10"></div><p id="priority-empty-msg" class="text-[10px] text-slate-400 text-center mt-2 hidden relative z-10">データが不足しています。学習を記録すると表示されます。</p></div><div id="section-achievements" class="grid grid-cols-2 gap-3"><div id="rank-card" class="col-span-2 glass-card p-4 border-b-4 border-slate-300 flex flex-col items-center text-center relative overflow-hidden transition-all duration-500"><div class="absolute top-0 left-0 w-full h-1 bg-slate-100/50"><div id="rank-progress" class="h-full bg-slate-400" style="width:0%"></div></div><span id="stat-rank-title" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">現在の称号</span><div class="flex items-end gap-1 my-1"><span id="stat-rank" class="text-3xl font-black text-slate-500 leading-none">F</span><span id="stat-rank-label" class="text-xs font-bold text-slate-500 mb-1">ランク</span></div><p id="stat-rank-text" class="text-[10px] font-medium text-slate-500 leading-tight">...</p><p id="stat-next-rank" class="text-[8px] font-bold text-slate-300 mt-2">次のランクまであと -- 時間</p></div><div class="stat-badge shadow-sm"><span class="text-[9px] font-bold uppercase opacity-80">累計学習時間</span><span id="stat-total-hours" class="text-xl font-bold">--h</span></div><div class="stat-badge shadow-sm bg-gradient-to-br from-indigo-500 to-purple-500"><span class="text-[9px] font-bold uppercase opacity-80">連続学習日数</span><span id="stat-streak-days" class="text-xl font-bold">--日</span></div></div><div id="section-radar" class="glass-card p-4 border-l-4 border-sky-400"><div class="flex justify-between items-center mb-4"><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">理解度分析</p><div id="radar-mode-label" class="text-[9px] font-bold text-sky-500 bg-sky-50 px-2 py-1 rounded">全体バランス</div></div><div class="relative"><canvas id="radarChart" height="250"></canvas><button id="btn-back-to-total" onclick="resetRadarMode()" class="hidden absolute top-0 right-0 text-[10px] bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold"><i class="fas fa-arrow-left mr-1"></i>戻る</button></div><div id="radar-subject-chips" class="flex flex-wrap gap-2 mt-4 overflow-x-auto pb-2"></div></div><div id="section-subject-time" class="glass-card p-5 border-l-4 border-sky-500"><p class="text-xs font-bold text-slate-400 mb-6 uppercase tracking-widest text-center">教科別合計時間</p><div id="subject-time-list" class="space-y-6"></div></div><div id="section-stats" class="glass-card p-4 border-l-4 border-indigo-400"><div class="flex justify-between items-center mb-4"><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">学習統計</p><div class="stats-toggle"><button onclick="setCalendarMode('month')" id="mode-month-btn" class="active">月</button><button onclick="setCalendarMode('week')" id="mode-week-btn" class="inactive">週</button></div></div><div id="calendar-month-view"><div class="flex justify-between items-center mb-3"><button onclick="changeCalendarView(-1,'month')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><i class="fas fa-chevron-left text-[9px] text-slate-400 group-hover:text-sky-500 absolute left-1.5"></i><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">先月</span></button><span id="calendar-month-label" class="text-sm font-bold text-slate-700 tracking-wider">----年--月</span><button onclick="changeCalendarView(1,'month')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">来月</span><i class="fas fa-chevron-right text-[9px] text-slate-400 group-hover:text-sky-500 absolute right-1.5"></i></button></div><div id="calendar-grid" class="grid grid-cols-7 gap-1"></div></div><div id="calendar-week-view" class="hidden space-y-6"><div class="flex justify-between items-center mb-3"><button onclick="changeCalendarView(-7,'week')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><i class="fas fa-chevron-left text-[9px] text-slate-400 group-hover:text-sky-500 absolute left-1.5"></i><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">先週</span></button><span id="calendar-week-label" class="text-xs font-bold text-slate-700 tracking-wider">--/-- 〜 --/--</span><button onclick="changeCalendarView(7,'week')" class="relative w-16 h-7 bg-white border border-slate-200 rounded-lg shadow-sm active:scale-95 transition-all hover:bg-slate-50 group flex items-center justify-center"><span class="text-[10px] font-bold text-slate-500 group-hover:text-sky-500 w-full text-center">来週</span><i class="fas fa-chevron-right text-[9px] text-slate-400 group-hover:text-sky-500 absolute right-1.5"></i></button></div><div class="grid grid-cols-7 gap-1 ml-[35px] px-1"><div class="flex flex-col items-center gap-1 group cursor-default"><div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative"><div class="week-bar-fill w-full absolute bottom-0" id="fill-sun"></div></div><div class="text-center"><div class="text-[9px] font-bold text-slate-400 leading-tight" id="date-sun">--</div><div class="text-[9px] font-bold text-slate-600 leading-tight" id="time-sun">--</div></div></div><div class="flex flex-col items-center gap-1 group cursor-default"><div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative"><div class="week-bar-fill w-full absolute bottom-0" id="fill-mon"></div></div><div class="text-center"><div class="text-[9px] font-bold text-slate-400 leading-tight" id="date-mon">--</div><div class="text-[9px] font-bold text-slate-600 leading-tight" id="time-mon">--</div></div></div><div class="flex flex-col items-center gap-1 group cursor-default"><div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative"><div class="week-bar-fill w-full absolute bottom-0" id="fill-tue"></div></div><div class="text-center"><div class="text-[9px] font-bold text-slate-400 leading-tight" id="date-tue">--</div><div class="text-[9px] font-bold text-slate-600 leading-tight" id="time-tue">--</div></div></div><div class="flex flex-col items-center gap-1 group cursor-default"><div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative"><div class="week-bar-fill w-full absolute bottom-0" id="fill-wed"></div></div><div class="text-center"><div class="text-[9px] font-bold text-slate-400 leading-tight" id="date-wed">--</div><div class="text-[9px] font-bold text-slate-600 leading-tight" id="time-wed">--</div></div></div><div class="flex flex-col items-center gap-1 group cursor-default"><div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative"><div class="week-bar-fill w-full absolute bottom-0" id="fill-thu"></div></div><div class="text-center"><div class="text-[9px] font-bold text-slate-400 leading-tight" id="date-thu">--</div><div class="text-[9px] font-bold text-slate-600 leading-tight" id="time-thu">--</div></div></div><div class="flex flex-col items-center gap-1 group cursor-default"><div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative"><div class="week-bar-fill w-full absolute bottom-0" id="fill-fri"></div></div><div class="text-center"><div class="text-[9px] font-bold text-slate-400 leading-tight" id="date-fri">--</div><div class="text-[9px] font-bold text-slate-600 leading-tight" id="time-fri">--</div></div></div><div class="flex flex-col items-center gap-1 group cursor-default"><div class="week-bar-container w-full bg-slate-100 rounded-full flex flex-col-reverse overflow-hidden relative"><div class="week-bar-fill w-full absolute bottom-0" id="fill-sat"></div></div><div class="text-center"><div class="text-[9px] font-bold text-slate-400 leading-tight" id="date-sat">--</div><div class="text-[9px] font-bold text-slate-600 leading-tight" id="time-sat">--</div></div></div></div><div id="timeline-container" class="timeline-grid border-t pt-4 mt-2"></div></div></div><div id="section-records" class="glass-card p-4 border-l-4 border-amber-400"><p class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">最高記録アワード</p><div class="space-y-3"><div class="flex items-center justify-between bg-amber-50 p-2.5 rounded-xl"><div class="flex items-center"><i class="fas fa-trophy text-amber-400 mr-3"></i><div><p class="text-[9px] text-amber-600 font-bold">1日の最高学習時間</p><p id="record-day-val" class="text-sm font-bold text-slate-700">--</p></div></div><span id="record-day-date" class="text-[8px] text-amber-300 font-bold">----/--/--</span></div><div class="flex items-center justify-between bg-sky-50 p-2.5 rounded-xl"><div class="flex items-center"><i class="fas fa-crown text-sky-400 mr-3"></i><div><p class="text-[9px] text-sky-600 font-bold">週の最高学習時間</p><p id="record-week-val" class="text-sm font-bold text-slate-700">--</p></div></div><span id="record-week-date" class="text-[8px] text-sky-300 font-bold">--週目</span></div><div class="flex items-center justify-between bg-indigo-50 p-2.5 rounded-xl"><div class="flex items-center"><i class="fas fa-medal text-indigo-400 mr-3"></i><div><p class="text-[9px] text-indigo-600 font-bold">月の最高学習時間</p><p id="record-month-val" class="text-sm font-bold text-slate-700">--</p></div></div><span id="record-month-date" class="text-[8px] text-indigo-300 font-bold">----/--</span></div></div></div></div><div id="page-list" class="page-transition hidden-page space-y-6"><div id="section-exam" class="glass-card p-5 border-l-4 border-rose-400"><h2 class="font-bold flex items-center text-slate-600 text-sm mb-4"><i class="fas fa-calendar-alt mr-2 text-rose-500"></i>試験カウントダウン</h2><div id="exam-list-container" class="space-y-3"></div><button onclick="showExamForm()" class="w-full mt-3 bg-white border border-rose-200 text-rose-500 py-2 rounded-lg text-xs font-bold hover:bg-rose-50 flex items-center justify-center gap-1"><i class="fas fa-plus"></i> 試験を追加</button><div id="exam-input-area" class="hidden mt-4 pt-4 border-t border-rose-100 space-y-3"><p class="text-xs font-bold text-slate-500 mb-2" id="exam-form-title">試験情報を入力</p><div class="grid grid-cols-2 gap-2"><input type="text" id="input-exam-name" placeholder="試験名" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-xs"><input type="date" id="input-exam-date" class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-xs"></div><div class="flex gap-2"><button id="btn-delete-exam" onclick="deleteExam()" class="hidden bg-red-50 text-red-400 py-2 px-3 rounded-lg text-xs font-bold flex items-center justify-center gap-1"><i class="fas fa-trash-alt"></i> 削除</button><button onclick="hideExamForm()" class="flex-1 bg-slate-100 text-slate-400 py-2 rounded-lg text-xs font-bold">キャンセル</button><button onclick="saveExam()" class="flex-1 bg-rose-500 text-white py-2 rounded-lg text-xs font-bold shadow-sm active:bg-rose-600">保存</button></div></div></div><section id="section-todo" class="glass-card p-5 border-l-4 border-indigo-400"><div class="flex justify-between items-center mb-4"><h2 class="font-bold flex items-center text-slate-600 text-sm"><i class="fas fa-check-square mr-2 text-indigo-500"></i>ToDo</h2><button onclick="confirmClearTodos()" class="text-[9px] font-bold text-indigo-400 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100">完了分削除</button></div><div class="flex gap-2 mb-4"><input type="text" id="todo-input" placeholder="タスクを入力" class="flex-grow bg-slate-50 border border-slate-100 rounded-lg p-2 text-sm focus:border-indigo-300 outline-none"><button onclick="addTodo()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold">追加</button></div><div id="todo-container" class="space-y-1"></div></section><div id="section-goals" class="glass-card p-4 border-l-4 border-indigo-500"><div class="flex justify-between items-center mb-4"><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">目標設定</p><button onclick="openGoalModal()" class="text-[10px] bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full font-bold hover:bg-indigo-100">教科別目標</button></div><div class="bg-slate-50 p-3 rounded-xl mb-4 border border-slate-100"><div class="flex justify-between items-center mb-2"><span id="goal-setting-label" class="text-[10px] font-bold text-slate-500">今日の目標</span><div id="daily-goal-value" class="text-xs font-bold text-indigo-600">-- 時間</div></div><div class="flex gap-2"><input type="number" id="input-daily-goal" placeholder="目標時間(h)" class="flex-grow text-xs p-2 rounded border border-slate-200"><button onclick="saveDailyGoal()" class="bg-indigo-500 text-white text-[10px] px-3 py-2 rounded-lg font-bold">保存</button></div></div><div id="goal-list" class="space-y-4"></div></div></div><div id="page-settings" class="page-transition hidden-page space-y-6"><div id="settings-container" class="space-y-6"></div></div></main><nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t flex justify-around p-3 z-50" id="bottom-nav"><button onclick="navigate('home')" id="nav-home" class="flex flex-col items-center text-sky-600"><i class="fas fa-home text-lg"></i><span class="text-[9px] mt-1 font-bold">ホーム</span></button><button onclick="navigate('analytics')" id="nav-analytics" class="flex flex-col items-center text-slate-300"><i class="fas fa-chart-line text-lg"></i><span class="text-[9px] mt-1 font-bold">分析</span></button><button onclick="navigate('list')" id="nav-list" class="flex flex-col items-center text-slate-300"><i class="fas fa-bullseye text-lg"></i><span class="text-[9px] mt-1 font-bold">目標</span></button><button onclick="navigate('settings')" id="nav-settings" class="flex flex-col items-center text-slate-300"><i class="fas fa-cog text-lg"></i><span class="text-[9px] mt-1 font-bold">設定</span></button></nav><div id="confirm-modal" class="modal" onclick="if(event.target===this)closeConfirmModal()"><div class="glass-card w-11/12 max-w-xs p-6 space-y-4 shadow-2xl"><div class="text-center"><h3 id="confirm-title" class="font-bold text-slate-700">確認</h3><p id="confirm-body" class="text-[11px] text-slate-400 mt-2"></p></div><div class="flex gap-2 pt-2"><button onclick="closeConfirmModal()" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl text-xs font-bold">取消</button><button id="confirm-execute-btn" class="flex-1 bg-sky-500 text-white py-3 rounded-xl text-xs font-bold shadow-lg">実行</button></div></div></div><div id="edit-modal" class="modal" onclick="if(event.target===this)closeModal()"><div class="glass-card w-11/12 max-w-xs p-6 space-y-4"><h3 class="font-bold text-center text-slate-700">記録の操作</h3><p id="edit-info" class="text-[10px] text-center text-slate-400"></p><div id="evaluation-edit-panel" class="grid grid-cols-5 gap-1"><button onclick="updateLog(1)" class="bg-red-50 text-red-600 py-3 rounded-lg font-bold">1</button><button onclick="updateLog(2)" class="bg-orange-50 text-orange-600 py-3 rounded-lg font-bold">2</button><button onclick="updateLog(3)" class="bg-yellow-50 text-yellow-600 py-3 rounded-lg font-bold">3</button><button onclick="updateLog(4)" class="bg-green-50 text-green-500 py-3 rounded-lg font-bold">4</button><button onclick="updateLog(5)" class="bg-blue-50 text-blue-500 py-3 rounded-lg font-bold">5</button></div><div class="flex gap-2"><button onclick="requestDeleteLog()" class="flex-1 bg-red-50 text-red-400 py-3 rounded-xl text-xs font-bold">削除</button><button onclick="closeModal()" class="flex-1 bg-sky-500 text-white py-3 rounded-xl text-xs font-bold">戻る</button></div></div></div><div id="goal-modal" class="modal" onclick="if(event.target===this)closeGoalModal()"><div class="glass-card w-11/12 max-w-xs p-6 space-y-4"><h3 id="goal-modal-title" class="font-bold text-center text-slate-700">新しい学習目標</h3><div class="space-y-3"><input type="text" id="goal-title" list="list-subjects" placeholder="教科" class="w-full bg-slate-50 border border-slate-100 rounded-lg p-3 text-sm focus:border-indigo-300 outline-none"><div class="flex items-center bg-slate-50 border border-slate-100 rounded-lg px-3"><input type="number" id="goal-target" placeholder="目標時間" class="w-full bg-transparent p-3 text-sm text-right outline-none"><span class="text-xs font-bold text-slate-400 ml-1">時間</span></div></div><div class="flex gap-2"><button id="goal-delete-btn" onclick="deleteGoalFromModal()" class="hidden bg-red-50 text-red-400 py-3 px-3 rounded-xl text-xs font-bold flex items-center justify-center gap-1"><i class="fas fa-trash-alt"></i> 削除</button><button onclick="closeGoalModal()" class="flex-1 bg-slate-50 text-slate-400 py-3 rounded-xl text-xs font-bold">取消</button><button id="goal-save-btn" onclick="saveGoalEntry()" class="flex-1 bg-indigo-500 text-white py-3 rounded-xl text-xs font-bold">保存</button></div></div></div><div id="msg-box" class="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white text-[10px] px-6 py-2 rounded-full opacity-0 transition-opacity z-[100] pointer-events-none"></div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// ★★ここにFirebaseの設定を貼り付け★★
const firebaseConfig = {
    apiKey: "AIzaSyAhDwueGffBsvD3SFicoZRGYD23SZeryOI",
    authDomain: "studyflow-2cca1.firebaseapp.com",
    projectId: "studyflow-2cca1",
    storageBucket: "studyflow-2cca1.firebasestorage.app",
    messagingSenderId: "44366511587",
    appId: "1:44366511587:web:a5099f7e4b040b74bdf4d6"
};

let app, db, auth, user = null;
try {
    if(firebaseConfig.apiKey){
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        onAuthStateChanged(auth, (u) => {
            user = u;
            updateAuthUI();
            if (u) { loadFromCloud(); showMessage("ログインしました"); }
        });
    } else {
        console.log("Firebase config missing - running in local mode");
    }
} catch (e) { console.log("Firebase init error", e); }

const el=id=>document.getElementById(id),LS=localStorage,JP=JSON.parse,JS=JSON.stringify,S={logs:JP(LS.getItem('studyflow_logs'))||[],timeRecords:JP(LS.getItem('studyflow_time'))||{},hourlyRecords:JP(LS.getItem('studyflow_hourly'))||{},subjectTimeRecords:JP(LS.getItem('studyflow_subjects'))||{},categoryTimeRecords:JP(LS.getItem('studyflow_categories'))||{},goals:JP(LS.getItem('studyflow_goals'))||[],todos:JP(LS.getItem('studyflow_todos'))||[],exams:JP(LS.getItem('studyflow_exams'))||[],dailyGoalSec:parseInt(LS.getItem('studyflow_daily_goal_sec'))||0,weeklyGoalSec:parseInt(LS.getItem('studyflow_weekly_goal_sec'))||0,monthlyGoalSec:parseInt(LS.getItem('studyflow_monthly_goal_sec'))||0,goalScope:LS.getItem('studyflow_goal_scope')||'day',history:JP(LS.getItem('studyflow_history'))||{subjects:[],books:[],categories:[]},featureSettings:JP(LS.getItem('studyflow_features'))||{'section-timer':!0,'section-todo':!0,'section-manual':!0,'section-eval':!0,'section-exam':!0,'section-radar':!0,'section-subject-time':!0,'section-goals':!0,'section-stats':!0,'section-review':!0,'section-achievements':!0,'section-records':!0,'section-priority':!0},userSettings:JP(LS.getItem('studyflow_user_settings'))||{pomoWork:25,pomoBreak:5,autoAddOvertime:!0},currentPage:'home',calendarMode:'month',viewDate:new Date,currentSession:{isRunning:!1,elapsed:0,mode:'stopwatch',pomoState:'work'},problemTimer:{isRunning:!1,elapsed:0},timerInterval:null,problemTimerInterval:null,editingId:null,editingGoalId:null,editingExamId:null,selectedRadarSubject:null,isFocused:!1,timers:{stopwatch:{isRunning:!1,elapsed:0},timer:{isRunning:!1,remaining:0,initial:0},pomodoro:{isRunning:!1,remaining:25*60,state:'work',overtime:0}},activeTimerMode:'stopwatch',intervalStarted:!1};
const elements={timerDisplay:el('timer-display'),problemTimerDisplay:el('problem-timer-display'),totalTimeDisplay:el('total-time-display'),goalList:el('goal-list'),subjectTimeList:el('subject-time-list'),reviewList:el('review-list'),msgBox:el('msg-box'),timerToggle:el('timer-toggle'),headerGoalFill:el('header-goal-fill'),headerGoalText:el('header-goal-text'),headerGoalPercent:el('header-goal-percent'),dailyGoalValue:el('daily-goal-value'),todoContainer:el('todo-container'),todoInput:el('todo-input')};
if(!LS.getItem('studyflow_exams')&&LS.getItem('studyflow_exam')){const old=JP(LS.getItem('studyflow_exam'));if(old)S.exams.push({id:Date.now(),name:old.name,date:old.date});LS.removeItem('studyflow_exam');LS.setItem('studyflow_exams',JS(S.exams))}
const RANKS=[{t:36e5,n:'EX',m:'1000時間を越えた者だけが立てる境地。'},{t:216e4,n:'SSS',m:'常人の域を超えた継続力を持つ者。'},{t:108e4,n:'SS',m:'量と質、その両方を積み重ねてきた証。'},{t:36e4,n:'S',m:'明確に、上位学習者の領域に入った。'},{t:108e3,n:'A',m:'努力が自信へと変わる段階に到達した。'},{t:36e3,n:'B',m:'勉強は「作業」ではなく、武器になる。'},{t:10800,n:'C',m:'続ける力が、確かな成果を生み始める。'},{t:3600,n:'D',m:'学ぶ習慣が形になりはじめた。'},{t:1800,n:'E',m:'最初の一歩を踏み出した。成長はもう始まっている。'},{t:0,n:'F',m:'まだ始まったばかり。ここからすべてが始まる。'}],featureLabels={'section-priority':'優先度','section-achievements':'ランク・称号','section-records':'最高記録アワード','section-exam':'試験日カウント','section-todo':'ToDoリスト','section-radar':'理解度分析'};
const formatTime=(s,sh=!0)=>{const h=Math.floor(s/3600),n=Math.floor((s%3600)/60),c=s%60,p=n=>String(n).padStart(2,'0');return sh?`${p(h)}:${p(n)}:${p(c)}`:`${p(n)}:${p(c)}`},getWeekNumber=d=>{d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));return Math.ceil((((d-new Date(Date.UTC(d.getUTCFullYear(),0,1)))/86400000)+1)/7)},getTodayStr=()=>new Date().toISOString().split('T')[0],pad=n=>n.toString().padStart(2,'0');
const StudyStats={cache:null,isDirty:!0,invalidate:function(){this.isDirty=!0},get:function(){if(!this.isDirty&&this.cache)return this.cache;const entries=Object.entries(S.timeRecords).filter(([_,s])=>s>0),totalSec=Object.values(S.timeRecords).reduce((a,b)=>a+b,0),currentRank=RANKS.find(r=>totalSec>=r.t),nextRank=RANKS[RANKS.indexOf(currentRank)-1]||null;let streak=0;const today=new Date;for(let i=0;i<365;i++){const d=new Date;d.setDate(today.getDate()-i);if(S.timeRecords[d.toISOString().split('T')[0]]>0)streak++;else if(i>0)break}let maxDay={val:0,date:'--'},maxWeek={val:0,date:'--'},maxMonth={val:0,date:'--'};if(entries.length>0){const maxDayEntry=entries.reduce((p,c)=>(p[1]>c[1])?p:c);maxDay={val:maxDayEntry[1],date:maxDayEntry[0]};const wm={},mm={};entries.forEach(([ds,sec])=>{const d=new Date(ds);wm[`${d.getFullYear()}-W${getWeekNumber(d)}`]=(wm[`${d.getFullYear()}-W${getWeekNumber(d)}`]||0)+sec;mm[ds.substring(0,7)]=(mm[ds.substring(0,7)]||0)+sec});if(Object.keys(wm).length>0){const w=Object.entries(wm).reduce((p,c)=>p[1]>c[1]?p:c);maxWeek={val:w[1],date:w[0]}}if(Object.keys(mm).length>0){const m=Object.entries(mm).reduce((p,c)=>p[1]>c[1]?p:c);maxMonth={val:m[1],date:m[0]}}}this.cache={totalSec,totalHours:totalSec/3600,rank:currentRank.n,rankText:currentRank.m,nextRank,streak,maxDay,maxWeek,maxMonth};this.isDirty=!1;return this.cache}};

// Firebase Logic
async function saveToCloud() {
    if (!user || !db) return;
    try {
        const dataToSave = {
            logs: S.logs, timeRecords: S.timeRecords, hourlyRecords: S.hourlyRecords, subjectTimeRecords: S.subjectTimeRecords, categoryTimeRecords: S.categoryTimeRecords, goals: S.goals, todos: S.todos, history: S.history, exams: S.exams, dailyGoalSec: S.dailyGoalSec, weeklyGoalSec: S.weeklyGoalSec, monthlyGoalSec: S.monthlyGoalSec, featureSettings: S.featureSettings, userSettings: S.userSettings
        };
        await setDoc(doc(db, "users", user.uid), dataToSave, { merge: true });
    } catch (e) { console.error("Cloud Save Error", e); }
}
async function loadFromCloud() {
    if (!user || !db) return;
    try {
        const docSnap = await getDoc(doc(db, "users", user.uid));
        if (docSnap.exists()) {
            const data = docSnap.data();
            Object.keys(data).forEach(k => { S[k] = data[k]; LS.setItem(`studyflow_${k}`, typeof data[k] === 'object' ? JS(data[k]) : data[k]); });
            refreshUI();
        }
    } catch (e) { console.error("Cloud Load Error", e); }
}
window.toggleAuth = async () => {
    if(!auth){showMessage("Firebase設定が必要です");return;}
    if (user) { await signOut(auth); showMessage("ログアウトしました"); location.reload(); }
    else {
        const email = prompt("メールアドレスを入力してください");
        if (!email) return;
        const pass = prompt("パスワードを入力してください (6文字以上)");
        if (!pass) return;
        try { await signInWithEmailAndPassword(auth, email, pass); }
        catch (e) {
            if (e.code === 'auth/user-not-found' || e.code === 'auth/invalid-credential') {
                if (confirm("新規登録しますか？")) {
                    try { await createUserWithEmailAndPassword(auth, email, pass); showMessage("登録・ログインしました"); }
                    catch (e2) { showMessage("エラー: " + e2.message); }
                }
            } else showMessage("エラー: " + e.message);
        }
    }
};
window.updateAuthUI = () => {const b=el('btn-auth'),s=el('auth-status');if(!b)return;if(user){s.innerText=`連携中: ${user.email}`;s.classList.replace('text-slate-700','text-green-600');b.innerText="ログアウト";}else{s.innerText="未連携 (ローカル保存)";s.classList.replace('text-green-600','text-slate-700');b.innerText="ログイン";}};

window.toggleFocus = id => {const t=el(id),h=el('main-header'),n=el('bottom-nav'),i=el(`icon-${id}`);if(!S.isFocused){t.classList.add('focus-mode');h.classList.add('hidden');n.classList.add('hidden');if(i)i.className='fas fa-compress-arrows-alt text-[10px]';S.isFocused=!0}else{t.classList.remove('focus-mode');h.classList.remove('hidden');n.classList.remove('hidden');if(i)i.className='fas fa-expand-alt text-[10px]';S.isFocused=!1}};
window.navigate = p => {if(S.isFocused)return;if(p==='analytics')StudyStats.invalidate();S.currentPage=p;['home','analytics','list','settings'].forEach(page=>{el(`page-${page}`).classList.toggle('hidden-page',page!==p);const n=el(`nav-${page}`);n.classList.toggle('text-sky-600',page===p);n.classList.toggle('text-slate-300',page!==p)});refreshUI()};
function save(){['logs','time','hourly','subjects','categories','goals','todos','history','exams','features','user_settings'].forEach(k=>LS.setItem(`studyflow_${k}`,JS(k==='time'?S.timeRecords:k==='hourly'?S.hourlyRecords:k==='subjects'?S.subjectTimeRecords:k==='categories'?S.categoryTimeRecords:k==='user_settings'?S.userSettings:k==='features'?S.featureSettings:S[k])));LS.setItem('studyflow_daily_goal_sec',S.dailyGoalSec);LS.setItem('studyflow_weekly_goal_sec',S.weeklyGoalSec);LS.setItem('studyflow_monthly_goal_sec',S.monthlyGoalSec);LS.setItem('studyflow_goal_scope',S.goalScope);StudyStats.invalidate(); saveToCloud();}
window.toggleFeature = id => {S.featureSettings[id]=!S.featureSettings[id];save();refreshUI()};
window.saveUserSettings = () => {S.userSettings.autoAddOvertime=el('setting-auto-overtime').checked;save();showMessage("設定を保存しました")};
function refreshUI(){Object.keys(S.featureSettings).forEach(id=>el(id)?.classList.toggle('hidden',!S.featureSettings[id]));['subjects','books','categories'].forEach(k=>el(`list-${k}`).innerHTML=S.history[k].map(s=>`<option value="${s}">`).join(''));updateTotalDisplay();if(!S.intervalStarted){S.intervalStarted=!0;setInterval(globalTimerLoop,1000)}if(S.currentPage==='home'){renderReviewList();updatePrioritySuggestions()}if(S.currentPage==='analytics'){renderRadar();renderSubjectTime();S.calendarMode==='month'?renderMonthCalendar():renderWeekCalendar();renderAchievements();updatePrioritySuggestions()}if(S.currentPage==='list'){renderExam();renderTodos();renderGoals()}if(S.currentPage==='settings'){renderFeatureSettings();updateAuthUI()}}
function globalTimerLoop(){const now=new Date(),ds=getTodayStr();let running=!1;if(S.timers.stopwatch.isRunning){S.timers.stopwatch.elapsed++;if(S.activeTimerMode==='stopwatch')running=!0}if(S.timers.timer.isRunning){S.timers.timer.remaining--;if(S.activeTimerMode==='timer')running=!0;if(S.timers.timer.remaining<=0){S.timers.timer.remaining=0;S.timers.timer.isRunning=!1;showMessage("タイマー終了！");updateTimerDisplay()}}if(S.timers.pomodoro.isRunning){S.timers.pomodoro.remaining--;if(S.activeTimerMode==='pomodoro')running=!0;if(S.timers.pomodoro.remaining<=0){S.timers.pomodoro.remaining=0;S.timers.pomodoro.isRunning=!1;showMessage(S.timers.pomodoro.state==='work'?"お疲れ様！休憩しましょう":"休憩終了！頑張りましょう");updateTimerDisplay()}}if(!S.timers.pomodoro.isRunning&&S.timers.pomodoro.remaining===0&&S.timers.pomodoro.state==='break'){S.timers.pomodoro.overtime=(S.timers.pomodoro.overtime||0)+1;if(S.activeTimerMode==='pomodoro')updateTimerDisplay()}if(running)updateTimerDisplay();['stopwatch','timer','pomodoro'].forEach(m=>el(`ind-${m}`)?.classList.toggle('hidden',!S.timers[m].isRunning));const isL=S.timers.stopwatch.isRunning||S.timers.timer.isRunning||(S.timers.pomodoro.isRunning&&S.timers.pomodoro.state==='work');if(isL){const sub=el('timer-subject').value.trim()||"その他",cat=el('timer-category').value.trim();S.timeRecords[ds]=(S.timeRecords[ds]||0)+1;S.subjectTimeRecords[sub]=(S.subjectTimeRecords[sub]||0)+1;if(cat)S.categoryTimeRecords[sub+':'+cat]=(S.categoryTimeRecords[sub+':'+cat]||0)+1;if(!S.hourlyRecords[ds])S.hourlyRecords[ds]=new Array(24).fill(0);S.hourlyRecords[ds][now.getHours()]++;updateTotalDisplay((S.timeRecords[ds]||0));if(now.getSeconds()%30===0)save()}}
function updateAIAdvice(){}
function renderAchievements(){const stats=StudyStats.get();el('stat-total-hours').innerText=`${Math.floor(stats.totalHours)}h`;el('stat-rank').innerText=stats.rank;el('stat-rank-text').innerText=stats.rankText;el('stat-streak-days').innerText=`${stats.streak}日`;const s={F:{b:'border-slate-300',t:'text-slate-500'},E:{b:'border-emerald-300',t:'text-emerald-600'},D:{b:'border-teal-300',t:'text-teal-600'},C:{b:'border-cyan-300',t:'text-cyan-600'},B:{b:'border-sky-400',t:'text-sky-600'},A:{b:'border-indigo-400',t:'text-indigo-600'},S:{b:'border-amber-400',t:'text-amber-600'},SS:{b:'border-rose-400',t:'text-rose-600'},SSS:{b:'border-purple-500',t:'text-purple-600'},EX:{b:'border-yellow-400',t:'text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-600',ex:1}}[stats.rank];const c=el('rank-card'),k=el('stat-rank'),l=el('stat-rank-label'),b=el('rank-progress'),rt=el('stat-rank-title'),rd=el('stat-rank-text'),rn=el('stat-next-rank');c.className=`col-span-2 glass-card p-4 border-b-4 flex flex-col items-center text-center relative overflow-hidden transition-all duration-500 ${s.b} ${stats.rank==='EX'?'bg-slate-900 shadow-xl':s.rank==='F'?'bg-white':s.b.replace('border','bg').replace('300','50').replace('400','50')}`;k.className=`text-3xl font-black leading-none ${s.t}`;l.className=`text-xs font-bold mb-1 ${s.ex?'text-yellow-500':s.t}`;b.className=`h-full ${s.ex?'bg-gradient-to-r from-yellow-300 to-yellow-600':s.b.replace('border','bg')}`;rt.className=`text-[9px] font-bold uppercase tracking-widest mt-1 ${s.ex?'text-yellow-500/50':'text-slate-400'}`;rd.className=`text-[10px] font-medium leading-tight ${s.ex?'text-slate-300':'text-slate-500'}`;rn.className=`text-[8px] font-bold mt-2 ${s.ex?'text-slate-500':'text-slate-300'}`;if(stats.nextRank){const diff=Math.max(0,(stats.nextRank.t-stats.totalSec)/3600).toFixed(1);rn.innerText=`次のランクまであと ${diff} 時間`;const base=RANKS.find(r=>r.n===stats.rank).t;b.style.width=`${Math.min(100,Math.max(0,((stats.totalSec-base)/(stats.nextRank.t-base))*100))}%`}else{rn.innerText="最高ランク到達！";b.style.width='100%'}el('record-day-val').innerText=formatTime(stats.maxDay.val,!0);el('record-day-date').innerText=stats.maxDay.date!=='--'?stats.maxDay.date.replace(/-/g,'/'):'--';el('record-week-val').innerText=formatTime(stats.maxWeek.val,!0);el('record-week-date').innerText=stats.maxWeek.date!=='--'?stats.maxWeek.date:'--';el('record-month-val').innerText=formatTime(stats.maxMonth.val,!0);el('record-month-date').innerText=stats.maxMonth.date!=='--'?stats.maxMonth.date:'--'}
function renderFeatureSettings(){el('settings-container').innerHTML=`<div class="glass-card p-6 border-l-4 border-slate-600"><h2 class="font-bold flex items-center text-slate-600 text-sm mb-6"><i class="fas fa-eye mr-2 text-slate-500"></i>表示カスタマイズ</h2><div class="space-y-4 mb-8">${Object.keys(featureLabels).map(id=>`<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="text-xs font-bold text-slate-700">${featureLabels[id]}</span><label class="toggle-switch"><input type="checkbox" ${S.featureSettings[id]?'checked':''} onchange="toggleFeature('${id}')"><span class="slider"></span></label></div>`).join('')}</div><h2 class="font-bold flex items-center text-slate-600 text-sm mb-6"><i class="fas fa-clock mr-2 text-slate-500"></i>ポモドーロ設定</h2><div class="space-y-4"><div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="text-xs font-bold text-slate-700">休憩超過分を勉強時間に加算</span><label class="toggle-switch"><input type="checkbox" id="setting-auto-overtime" ${S.userSettings.autoAddOvertime?'checked':''} onchange="saveUserSettings()"><span class="slider"></span></label></div></div><div class="mt-8 pt-6 border-t border-slate-100 text-center flex justify-center gap-4"><button onclick="toggleAuth()" class="flex-1 bg-sky-500 text-white py-3 rounded-xl text-xs font-bold"><i class="fas fa-user mr-1"></i>${user?'ログアウト':'ログイン / 登録'}</button><button onclick="exportData()" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl text-xs font-bold"><i class="fas fa-download mr-1"></i>データ保存</button><button onclick="resetAllData()" class="flex-1 bg-red-50 text-red-400 py-3 rounded-xl text-xs font-bold"><i class="fas fa-trash-alt mr-1"></i>全初期化</button></div></div>`}
window.toggleTimer = () => {if(S.activeTimerMode==='pomodoro')return;const t=S.timers[S.activeTimerMode];if(!t.isRunning){if(!el('timer-category').value.trim()){showMessage("分野を入力してください");el('timer-category').focus();return}}t.isRunning=!t.isRunning;if(!t.isRunning)save();updateTimerDisplay()};
window.setTimerMode = m => {S.activeTimerMode=m;['stopwatch','timer','pomodoro'].forEach(mod=>{const b=el(`btn-${mod}`);b.className=mod===m?'relative text-xs px-4 py-1.5 rounded-full bg-sky-100 text-sky-600 font-bold transition-all':'relative text-xs px-4 py-1.5 rounded-full bg-gray-100 text-gray-500 transition-all'});el('quick-adjust-panel').classList.toggle('hidden',m!=='timer');el('pomodoro-setting-panel').classList.toggle('hidden',m!=='pomodoro');if(m==='pomodoro'){el('pomo-work-min').value=S.userSettings.pomoWork;el('pomo-break-min').value=S.userSettings.pomoBreak;if(!S.timers.pomodoro.isRunning&&S.timers.pomodoro.state==='work')S.timers.pomodoro.remaining=S.userSettings.pomoWork*60}updateTimerDisplay()};
function updTmrDisplay(){updateTimerDisplay()}
function updateTimerDisplay(){const m=S.activeTimerMode,t=S.timers[m],btn=elements.timerToggle,st=el('timer-status'),disp=elements.timerDisplay,sub=el('pomo-sub-actions'),sec=el('section-timer'),foc=sec.classList.contains('focus-mode');sec.className=`glass-card p-6 text-center border-l-4 border-sky-400${foc?' focus-mode':''}`;let dt=m==='stopwatch'?t.elapsed:t.remaining;if(m!=='pomodoro'){disp.innerText=formatTime(dt);disp.className="text-6xl font-mono font-bold text-slate-700 tabular-nums tracking-tight mb-6 timer-text-large";sub.classList.add('hidden');if(t.isRunning){btn.innerHTML='<i class="fas fa-pause text-xl mb-1"></i><span class="text-xs font-bold uppercase">一時停止</span>';btn.className="btn-main w-32 h-16 bg-orange-500 text-white rounded-2xl shadow-lg";st.innerText=m==='timer'?"Timer Running...":"Counting...";btn.onclick=toggleTimer}else{const r=(m==='timer'&&t.remaining>0&&t.remaining<t.initial)||(m==='stopwatch'&&t.elapsed>0);btn.innerHTML=`<i class="fas fa-play text-xl mb-1"></i><span class="text-xs font-bold uppercase">${r?'再開':'学習開始'}</span>`;btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";st.innerText="Ready to Study";btn.onclick=toggleTimer}}else{const w=t.state==='work';if(!w){sub.classList.remove('hidden');sub.innerHTML=`<button onclick="startPomoWork()" class="text-xs font-bold text-sky-400 underline hover:text-sky-500">休憩を終了して勉強する</button>`;disp.innerText=formatTime(t.remaining>0?t.remaining:(t.overtime||0));disp.className=`text-6xl font-mono font-bold tabular-nums tracking-tight mb-6 timer-text-large ${t.remaining>0?'text-teal-400':'text-orange-400'}`}else{sub.classList.add('hidden');disp.innerText=formatTime(t.remaining);disp.className="text-6xl font-mono font-bold text-slate-700 tabular-nums tracking-tight mb-6 timer-text-large"}if(t.remaining<=0){if(w){btn.innerHTML='<i class="fas fa-mug-hot text-xl mb-1"></i><span class="text-xs font-bold uppercase">休憩開始</span>';btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";st.innerText="Work Done!";btn.onclick=startPomoBreak}else{btn.innerHTML='<i class="fas fa-book-open text-xl mb-1"></i><span class="text-xs font-bold uppercase">勉強再開</span>';btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";st.innerText="Break Done!";btn.onclick=startPomoWork}}else{if(t.isRunning){btn.innerHTML='<i class="fas fa-pause text-xl mb-1"></i><span class="text-xs font-bold uppercase">一時停止</span>';btn.className="btn-main w-32 h-16 bg-orange-500 text-white rounded-2xl shadow-lg";st.innerText=w?"Focusing...":"Relaxing...";btn.onclick=()=>{t.isRunning=!1;save();updateTimerDisplay()}}else{btn.innerHTML='<i class="fas fa-play text-xl mb-1"></i><span class="text-xs font-bold uppercase">再開</span>';btn.className="btn-main w-32 h-16 bg-sky-500 text-white rounded-2xl shadow-lg";st.innerText="Paused";btn.onclick=()=>{if(!el('timer-category').value.trim()){showMessage("分野を入力してください");el('timer-category').focus();return}t.isRunning=!0;updateTimerDisplay()}}}}}
window.updatePomodoroWorkTime = () => {const v=parseInt(el('pomo-work-min').value)||25;S.userSettings.pomoWork=v;save();if(!S.timers.pomodoro.isRunning&&S.timers.pomodoro.state==='work'){S.timers.pomodoro.remaining=v*60;updateTimerDisplay()}};
window.updatePomodoroBreakTime = () => {const v=parseInt(el('pomo-break-min').value)||5;S.userSettings.pomoBreak=v;save();if(!S.timers.pomodoro.isRunning&&S.timers.pomodoro.state==='break'){S.timers.pomodoro.remaining=v*60;updateTimerDisplay()}};
window.adjustTime = v => {if(S.activeTimerMode==='timer'){S.timers.timer.remaining=Math.max(0,S.timers.timer.remaining+v);updateTimerDisplay()}};
window.resetTimer = () => {const m=S.activeTimerMode,t=S.timers[m];t.isRunning=!1;if(m==='stopwatch')t.elapsed=0;else if(m==='timer')t.remaining=0;else if(m==='pomodoro'){t.state='work';t.remaining=S.userSettings.pomoWork*60;t.overtime=0;el('pomo-work-min').value=S.userSettings.pomoWork;el('pomo-break-min').value=S.userSettings.pomoBreak}save();updateTimerDisplay()};
window.startPomoWork = () => {if(!el('timer-category').value.trim()){showMessage("分野を入力してください");el('timer-category').focus();return}const t=S.timers.pomodoro,b=parseInt(el('pomo-work-min').value)||S.userSettings.pomoWork,o=(S.userSettings.autoAddOvertime&&t.overtime)?t.overtime:0;t.remaining=(b*60)+o;t.state='work';t.isRunning=!0;t.overtime=0;showMessage(o>0?`休憩超過 ${formatTime(o,!1)} を追加`:"勉強スタート！");updateTimerDisplay()};
window.startPomoBreak = () => {const t=S.timers.pomodoro,b=parseInt(el('pomo-break-min').value)||S.userSettings.pomoBreak;t.remaining=b*60;t.state='break';t.isRunning=!0;showMessage("休憩スタート！");updateTimerDisplay()};
window.toggleProblemTimer = () => {const b=el('problem-timer-btn'),l=el('problem-timer-limit');if(S.problemTimer.isRunning){clearInterval(S.problemTimerInterval);S.problemTimer.isRunning=!1;b.innerHTML='<i class="fas fa-play mr-2"></i>計測開始';b.className="bg-sky-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm active:bg-sky-600";l.disabled=!1}else{S.problemTimer.isRunning=!0;b.innerHTML='<i class="fas fa-pause mr-2"></i>停止';b.className="bg-orange-400 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm";l.disabled=!0;S.problemTimerInterval=setInterval(()=>{S.problemTimer.elapsed++;const e=S.problemTimer.elapsed;elements.problemTimerDisplay.innerText=formatTime(e,!1);const c=el('problem-countdown-display'),lm=parseFloat(l.value)||0;if(lm>0){const r=(lm*60)-e;c.innerText=r>=0?"あと "+formatTime(r,!1):"超過 "+formatTime(Math.abs(r),!1);c.className=`text-xs font-mono font-bold ${r>=0?'text-sky-500':'text-rose-500'}`}else{c.innerText="--:--";c.className="text-xs font-mono font-bold text-slate-300"}},1000)}};
window.updateCountdownDisplay = () => {const m=parseFloat(el('problem-timer-limit').value)||0,c=el('problem-countdown-display');if(m>0&&S.problemTimer.elapsed===0){c.innerText="あと "+formatTime(m*60,!1);c.className="text-xs font-mono font-bold text-slate-400"}else if(S.problemTimer.elapsed===0){c.innerText="--:--";c.className="text-xs font-mono font-bold text-slate-300"}};
function resetProblemTimerDisplay(){if(!S.problemTimer.isRunning){elements.problemTimerDisplay.classList.remove('text-red-500');elements.problemTimerDisplay.innerText="00:00";updateCountdownDisplay()}}
window.recordEvaluation = lv => {const sub=el('input-subject').value.trim()||"その他",book=el('input-book').value.trim()||"その他",cat=el('input-category').value.trim(),no=el('input-problem-no').value,d=S.problemTimer.elapsed;S.logs.push({id:Date.now(),subject:sub,book:book,category:cat,problemNo:no,level:lv,timestamp:new Date().toISOString(),type:'evaluation',duration:d});['subjects','books','categories'].forEach((k,i)=>{const v=[sub,book,cat][i];if(v&&!S.history[k].includes(v))S.history[k].push(v)});el('input-problem-no').value=parseInt(no)+1;el('last-lap-hint').innerText=`前回: ${formatTime(d,!1)}`;if(S.problemTimer.isRunning)toggleProblemTimer();S.problemTimer.elapsed=0;elements.problemTimerDisplay.innerText="00:00";resetProblemTimerDisplay();updateLastLapDisplay();if(cat)S.categoryTimeRecords[sub+':'+cat]=(S.categoryTimeRecords[sub+':'+cat]||0)+d;save();refreshUI();showMessage("記録完了")};
window.submitManualTime = () => {const sub=el('manual-subject').value.trim()||"その他",cat=el('manual-category').value.trim(),m=parseInt(el('manual-minutes').value)||0,ds=el('manual-date').value,ts=el('manual-start-time').value;if(!ds||!m)return showMessage("入力内容を確認してください");const stT=ts||`${pad(new Date().getHours())}:${pad(new Date().getMinutes())}`,dur=m*60,sDT=new Date(`${ds}T${stT}`);S.logs.push({id:Date.now(),subject:sub,category:cat,manualDuration:dur,type:'manual',timestamp:sDT.toISOString()});S.timeRecords[ds]=(S.timeRecords[ds]||0)+dur;S.subjectTimeRecords[sub]=(S.subjectTimeRecords[sub]||0)+dur;if(cat)S.categoryTimeRecords[sub+':'+cat]=(S.categoryTimeRecords[sub+':'+cat]||0)+dur;if(!S.history.subjects.includes(sub))S.history.subjects.push(sub);if(cat&&!S.history.categories.includes(cat))S.history.categories.push(cat);let cur=new Date(sDT),rem=dur;while(rem>0){const d=cur.toISOString().split('T')[0],h=cur.getHours(),nh=new Date(cur);nh.setHours(h+1,0,0,0);const diff=(nh-cur)/1000,cons=Math.min(rem,diff);if(!S.hourlyRecords[d])S.hourlyRecords[d]=new Array(24).fill(0);S.hourlyRecords[d][h]+=cons;rem-=cons;cur=nh}save();refreshUI();el('manual-minutes').value='';showMessage("記録しました")};
window.updateLastLapDisplay = () => {const s=el('input-subject').value.trim(),b=el('input-book').value.trim(),c=el('input-category').value.trim(),n=el('input-problem-no').value,l=S.logs.slice().reverse().find(x=>x.type==='evaluation'&&x.subject===s&&x.book===b&&x.category===c&&x.problemNo==n);if(l&&l.duration!==undefined){el('last-lap-hint').innerText=`前回: ${formatTime(l.duration,!1)}`;el('problem-timer-limit').value=(l.duration*0.9/60).toFixed(1);updateCountdownDisplay()}else{el('last-lap-hint').innerText="前回: --:--";el('problem-timer-limit').value="";updateCountdownDisplay()}};
window.renderReviewList = () => {const l=elements.reviewList;if(!l)return;const tf=el('list-filter-type').value,lf=el('list-filter-level').value,sf=el('list-filter-subject').value,cf=el('list-filter-category').value,subs=[...new Set(S.logs.map(x=>x.subject))].sort(),cats=[...new Set(S.logs.map(x=>x.category).filter(Boolean))].sort();el('list-filter-subject').innerHTML='<option value="all">全教科</option>'+subs.map(s=>`<option value="${s}" ${s===sf?'selected':''}>${s}</option>`).join('');el('list-filter-category').innerHTML='<option value="all">全分野</option>'+cats.map(c=>`<option value="${c}" ${c===cf?'selected':''}>${c}</option>`).join('');let i=[...S.logs].reverse();if(tf!=='all')i=i.filter(x=>x.type===tf);if(lf!=='all'){const v=parseInt(lf.slice(2));i=i.filter(x=>x.level&&x.level<=v)}if(sf!=='all')i=i.filter(x=>x.subject===sf);if(cf!=='all')i=i.filter(x=>x.category===cf);const cl=['','text-red-500 bg-red-50','text-orange-500 bg-orange-50','text-yellow-600 bg-yellow-50','text-green-500 bg-green-50','text-blue-500 bg-blue-50'];l.innerHTML=i.length?i.map(x=>`<div onclick="openEdit(${x.id})" class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl shadow-sm active:bg-slate-50 transition-colors"><div class="overflow-hidden"><p class="text-[8px] text-slate-400 font-bold uppercase">${new Date(x.timestamp).toLocaleDateString()}</p><p class="text-xs font-bold text-slate-700 truncate">${x.subject} ${x.problemNo?'No.'+x.problemNo:''}</p>${x.category?`<p class="text-[9px] text-slate-400">${x.category}</p>`:''}</div>${x.level?`<span class="text-[9px] font-bold px-2 py-1 rounded-lg ${cl[x.level]} whitespace-nowrap">Lv.${x.level}</span>`:`<span class="text-[9px] font-bold px-2 py-1 rounded-lg bg-emerald-50 text-emerald-600 whitespace-nowrap">${Math.floor(x.manualDuration/60)}分</span>`}</div>`).join(''):'<p class="text-xs text-slate-300 text-center py-10">履歴はありません</p>'};
function updatePrioritySuggestions(){const l=el('priority-list'),em=el('priority-empty-msg');if(!l)return;const agg={};for(const k in S.categoryTimeRecords){const[s,c]=k.split(':');agg[k]={subject:s,category:c,totalTime:S.categoryTimeRecords[k],levels:[]}}S.logs.forEach(x=>{if(!x.subject||!x.category||!x.level)return;const k=x.subject+':'+x.category;if(!agg[k])agg[k]={subject:x.subject,category:x.category,totalTime:0,levels:[]};agg[k].levels.push(x.level)});const items=Object.values(agg);if(items.length===0){l.innerHTML='';em.classList.remove('hidden');return}em.classList.add('hidden');const totalT=items.reduce((a,b)=>a+b.totalTime,0),avgT=items.length>0?totalT/items.length:0,prio=items.map(i=>{const avgl=i.levels.length>0?i.levels.reduce((a,b)=>a+b,0)/i.levels.length:0;let ps=0,r="",rt="medium";if(avgl>=4.0)ps=-100;else if(i.totalTime>avgT*1.2&&avgl<3.0&&avgl>0){ps=100+(i.totalTime/60);r="時間の割に理解が低い";rt="high"}else if(i.totalTime<avgT*0.5&&avgl<3.0){ps=80+(5-(avgl||1))*10;r="学習不足";rt="high"}else if(avgl<2.5&&avgl>0){ps=60+(i.totalTime/60);r="効率が悪い";rt="medium"}else{ps=(5-(avgl||2.5))*10;r="理解度強化が必要";rt="medium"}return{...i,ps,r,rt}}).filter(i=>i.ps>0).sort((a,b)=>b.ps-a.ps).slice(0,3);if(prio.length===0){l.innerHTML='<p class="text-[10px] text-slate-400 text-center py-2">優先課題なし</p>';return}l.innerHTML=prio.map(i=>`<div class="priority-item ${i.rt==='high'?'priority-high':'priority-medium'} p-2 rounded-r-lg mb-1 flex justify-between items-center shadow-sm"><div><div class="flex items-baseline gap-2"><span class="text-xs font-bold text-slate-700">${i.subject}</span><span class="text-[10px] text-slate-500">${i.category}</span></div></div><span class="text-[9px] font-bold ${i.rt==='high'?'text-rose-500':'text-orange-500'} bg-white px-2 py-1 rounded-full border border-slate-100 shadow-sm">${i.r}</span></div>`).join('')}
window.openEdit = id => {S.editingId=id;const l=S.logs.find(x=>x.id===id);if(!l)return;el('edit-info').innerText=`${l.subject} の記録`;el('evaluation-edit-panel').classList.toggle('hidden',l.type==='manual');el('edit-modal').classList.add('active')};
window.closeModal = () => {el('edit-modal').classList.remove('active')};
window.updateLog = lv => {const i=S.logs.findIndex(x=>x.id===S.editingId);if(i!==-1){S.logs[i].level=lv;save();refreshUI()}closeModal()};
window.requestDeleteLog = () => {const l=S.logs.find(x=>x.id===S.editingId);if(!l)return;if(l.type==='manual'){const d=new Date(l.timestamp).toISOString().split('T')[0],dr=l.manualDuration||0;if(S.timeRecords[d])S.timeRecords[d]=Math.max(0,S.timeRecords[d]-dr);if(S.subjectTimeRecords[l.subject])S.subjectTimeRecords[l.subject]=Math.max(0,S.subjectTimeRecords[l.subject]-dr);if(l.category){const k=l.subject+':'+l.category;S.categoryTimeRecords[k]=Math.max(0,(S.categoryTimeRecords[k]||0)-dr)}}S.logs=S.logs.filter(x=>x.id!==S.editingId);save();refreshUI();closeModal();showMessage("削除しました")};
window.setGoalScope = s => {S.goalScope=s;el('goal-toggle-day').className=s==='day'?'active':'inactive';el('goal-toggle-week').className=s==='week'?'active':'inactive';el('goal-toggle-month').className=s==='month'?'active':'inactive';save();refreshUI()};
window.saveDailyGoal = () => {const v=parseFloat(el('input-daily-goal').value)||0;if(S.goalScope==='day')S.dailyGoalSec=v*3600;else if(S.goalScope==='week')S.weeklyGoalSec=v*3600;else S.monthlyGoalSec=v*3600;save();refreshUI();el('input-daily-goal').value=""};
window.openGoalModal = (id=null) => {S.editingGoalId=id;const t=el('goal-modal-title'),b=el('goal-save-btn'),d=el('goal-delete-btn');if(id){const g=S.goals.find(x=>x.id===id);if(g){el('goal-title').value=g.title;el('goal-target').value=g.targetSec/3600;t.innerText="目標を編集";b.innerText="更新";d.classList.remove('hidden')}}else{el('goal-title').value='';el('goal-target').value='';t.innerText="新しい学習目標";b.innerText="保存";d.classList.add('hidden')}el('goal-modal').classList.add('active')};
window.closeGoalModal = () => {el('goal-modal').classList.remove('active')};
window.saveGoalEntry = () => {const t=el('goal-title').value.trim(),v=parseInt(el('goal-target').value)||0;if(t&&v>0){if(S.editingGoalId){const i=S.goals.findIndex(x=>x.id===S.editingGoalId);if(i!==-1){S.goals[i].title=t;S.goals[i].targetSec=v*3600;showMessage("目標を更新しました")}}else{S.goals.push({id:Date.now(),title:t,targetSec:v*3600});showMessage("目標を追加しました")}save();refreshUI();closeGoalModal()}else showMessage("教科と時間を入力してください")};
window.deleteGoalFromModal = () => {if(S.editingGoalId){closeGoalModal();confirmDeleteGoal(S.editingGoalId)}};
window.confirmDeleteGoal = id => {showConfirm("目標を削除","この目標を削除しますか？",()=>{S.goals=S.goals.filter(x=>x.id!==id);save();refreshUI()})};
window.renderGoals = () => {elements.goalList.innerHTML=S.goals.map(g=>{const t=S.subjectTimeRecords[g.title]||0,p=Math.min(100,(t/g.targetSec)*100);return `<div class="space-y-2 cursor-pointer hover:bg-slate-50 p-2 -mx-2 rounded-lg transition-colors" onclick="openGoalModal(${g.id})"><div class="flex justify-between items-end"><span class="text-[10px] font-bold text-slate-500">${g.title}</span><div class="flex gap-2 items-center"><span class="text-[10px] font-bold text-indigo-500">${Math.round(p)}%</span></div></div><div class="goal-progress-bar"><div class="goal-progress-fill" style="width: ${p}%"></div></div></div>`}).join('')||'<p class="text-[10px] text-slate-300 text-center py-4">教科別の目標はありません</p>';const gt=S.goalScope==='day'?S.dailyGoalSec:(S.goalScope==='week'?S.weeklyGoalSec:S.monthlyGoalSec);elements.dailyGoalValue.innerText=gt>0?`${(gt/3600).toFixed(1)} 時間`:"-- 時間";const gm={day:"今日の目標",week:"今週の目標",month:"今月の目標"};el('goal-setting-label').innerText=gm[S.goalScope]||"目標"};
window.renderExam = () => {const l=el('exam-list-container');if(!S.exams.length){l.innerHTML='<p class="text-xs text-slate-300 text-center py-2">試験は登録されていません</p>';return}l.innerHTML=S.exams.map(e=>{const d=Math.ceil((new Date(e.date)-new Date().setHours(0,0,0,0))/(1e3*60*60*24));return `<div onclick="showExamForm(${e.id})" class="flex justify-between items-center bg-rose-50 p-3 rounded-xl border border-rose-100 cursor-pointer hover:bg-rose-100 transition-colors"><div><p class="text-xs font-bold text-rose-600">${e.name}</p><p class="text-[9px] text-rose-400">${e.date.replace(/-/g,'/')}</p></div><div class="flex items-baseline gap-1"><span class="text-[10px] text-slate-400 font-bold">あと</span><span class="text-2xl font-black text-rose-500">${d>=0?d:"終了"}</span><span class="text-xs font-bold text-rose-600">日</span></div></div>`}).join('')}
window.showExamForm = (id=null) => {S.editingExamId=id;const a=el('exam-input-area'),d=el('btn-delete-exam'),t=el('exam-form-title');a.classList.remove('hidden');if(id){const e=S.exams.find(x=>x.id===id);if(e){el('input-exam-name').value=e.name;el('input-exam-date').value=e.date;t.innerText="試験を編集";d.classList.remove('hidden')}}else{el('input-exam-name').value='';el('input-exam-date').value='';t.innerText="新しい試験を追加";d.classList.add('hidden')}};
window.hideExamForm = () => {el('exam-input-area').classList.add('hidden');S.editingExamId=null};
window.saveExam = () => {const n=el('input-exam-name').value,d=el('input-exam-date').value;if(n&&d){if(S.editingExamId){const i=S.exams.findIndex(x=>x.id===S.editingExamId);if(i!==-1){S.exams[i].name=n;S.exams[i].date=d;showMessage("試験を更新しました")}}else{S.exams.push({id:Date.now(),name:n,date:d});showMessage("試験を追加しました")}save();renderExam();hideExamForm()}};
window.deleteExam = () => {if(S.editingExamId){showConfirm("試験を削除","この試験データを削除しますか？",()=>{S.exams=S.exams.filter(x=>x.id!==S.editingExamId);save();renderExam();hideExamForm();showMessage("削除しました")})}};
window.editExam = () => {el('exam-display-area').classList.add('hidden');el('exam-input-area').classList.remove('hidden')};
window.addTodo = () => {const t=elements.todoInput.value.trim();if(t){S.todos.push({id:Date.now(),text:t,completed:!1});elements.todoInput.value='';save();renderTodos()}};
window.toggleTodo = id => {const t=S.todos.find(x=>x.id===id);if(t){t.completed=!t.completed;save();renderTodos()}};
window.deleteTodo = id => {S.todos=S.todos.filter(x=>x.id!==id);save();renderTodos()};
window.confirmClearTodos = () => {if(S.todos.some(x=>x.completed))showConfirm("完了分を削除","完了したタスクを削除してもよろしいですか？",()=>{S.todos=S.todos.filter(x=>!x.completed);save();renderTodos()})};
window.renderTodos = () => {elements.todoContainer.innerHTML=S.todos.map(t=>`<div class="todo-item ${t.completed?'completed':''}"><div class="todo-check ${t.completed?'active':''}" onclick="toggleTodo(${t.id})"></div><span class="flex-grow text-sm font-medium text-slate-700">${t.text}</span><button onclick="deleteTodo(${t.id})" class="text-slate-300 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt text-xs"></i></button></div>`).join('')||'<p class="text-[10px] text-slate-300 text-center py-4">タスクはありません</p>'};
window.setCalendarMode = m => {S.calendarMode=m;el('calendar-month-view').classList.toggle('hidden',m!='month');el('calendar-week-view').classList.toggle('hidden',m!='week');el('mode-month-btn').className=m=='month'?'active':'inactive';el('mode-week-btn').className=m=='week'?'active':'inactive';refreshUI()};
window.changeCalendarView = (d,m) => {if(m=='month')S.viewDate.setMonth(S.viewDate.getMonth()+d);else S.viewDate.setDate(S.viewDate.getDate()+d);refreshUI()};
window.renderMonthCalendar = () => {const c=el('calendar-grid');c.innerHTML='';const y=S.viewDate.getFullYear(),m=S.viewDate.getMonth();el('calendar-month-label').innerText=`${y}年${m+1}月`;['日','月','火','水','木','金','土'].forEach(d=>c.innerHTML+=`<div class="text-[9px] text-center text-slate-300 font-bold">${d}</div>`);const f=new Date(y,m,1).getDay(),l=new Date(y,m+1,0).getDate();for(let i=0;i<f;i++)c.innerHTML+='<div></div>';for(let d=1;d<=l;d++){const ds=`${y}-${pad(m+1)}-${pad(d)}`,h=S.timeRecords[ds]?Math.min(4,Math.floor(S.timeRecords[ds]/3600)+1):0;c.innerHTML+=`<div class="day-cell heat-${h} text-slate-400 font-bold">${d}</div>`}}
window.renderWeekCalendar = () => {const b=new Date(S.viewDate),x=b.getDay(),ds=[0,1,2,3,4,5,6].map(i=>{const d=new Date(b);d.setDate(b.getDate()+(i-x));return d.toISOString().split('T')[0]});el('calendar-week-label').innerText=`${ds[0].slice(5)} ~ ${ds[6].slice(5)}`;let max=3600;ds.forEach(d=>max=Math.max(max,S.timeRecords[d]||0));['sun','mon','tue','wed','thu','fri','sat'].forEach((d,i)=>{const s=S.timeRecords[ds[i]]||0;el(`fill-${d}`).style.height=`${(s/max)*100}%`;const date=new Date(ds[i]),de=el(`date-${d}`),te=el(`time-${d}`);if(de){de.innerText=`${date.getDate()}(${['日','月','火','水','木','金','土'][i]})`;de.className=(ds[i]===getTodayStr())?"text-[9px] font-bold text-sky-500 leading-tight":"text-[9px] font-bold text-slate-400 leading-tight"}if(te){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);te.innerText=s>0?(h>0?`${h}h`:``)+`${m}m`:'--';te.className=s>0?"text-[9px] font-bold text-slate-600 leading-tight":"text-[9px] font-bold text-slate-300 leading-tight"}});const t=el('timeline-container');t.innerHTML='';for(let h=0;h<24;h++){t.innerHTML+=`<div class="timeline-time-label">${h}</div>`;ds.forEach(d=>{const v=S.hourlyRecords[d]?.[h]?Math.min(4,Math.floor(S.hourlyRecords[d][h]/900)+1):0;t.innerHTML+=`<div class="timeline-cell hour-heat-${v}"></div>`})}}
window.resetRadarMode = () => {S.selectedRadarSubject=null;el('btn-back-to-total').classList.add('hidden');el('radar-mode-label').innerText="全体バランス";refreshUI()};
window.selectRadarSubject = s => {S.selectedRadarSubject=s;el('btn-back-to-total').classList.remove('hidden');el('radar-mode-label').innerText=s;refreshUI()};
window.renderRadar = () => {const subs=[...new Set(S.logs.filter(l=>l.level).map(l=>l.subject))];el('radar-subject-chips').innerHTML=subs.map(s=>`<div onclick="selectRadarSubject('${s}')" class="category-chip ${S.selectedRadarSubject===s?'active':''}">${s}</div>`).join('');let l=[],d=[];if(S.selectedRadarSubject){const m={};S.logs.filter(x=>x.subject===S.selectedRadarSubject&&x.level).forEach(x=>{(m[x.category]=m[x.category]||[]).push(x.level)});l=Object.keys(m);d=l.map(c=>(m[c].reduce((a,b)=>a+b,0)/m[c].length).toFixed(1))}else{const m={};S.logs.filter(x=>x.level).forEach(x=>{(m[x.subject]=m[x.subject]||[]).push(x.level)});l=Object.keys(m);d=l.map(s=>(m[s].reduce((a,b)=>a+b,0)/m[s].length).toFixed(1))}if(radarInst)radarInst.destroy();if(l.length===0)return;radarInst=new Chart(el('radarChart'),{type:'radar',data:{labels:l,datasets:[{data:d,backgroundColor:'rgba(14,165,233,0.1)',borderColor:'#0ea5e9',borderWidth:2,pointBackgroundColor:'#0ea5e9'}]},options:{scales:{r:{min:0,max:5,ticks:{display:!1,stepSize:1},grid:{color:'#f1f5f9'}}},plugins:{legend:{display:!1}}}});};
window.renderSubjectTime = () => {const k=Object.keys(S.subjectTimeRecords).sort((a,b)=>S.subjectTimeRecords[b]-S.subjectTimeRecords[a]),m=k.length>0?S.subjectTimeRecords[k[0]]:1;elements.subjectTimeList.innerHTML=k.map(s=>{const t=S.subjectTimeRecords[s],w=(t/m)*100,h=Math.floor(t/3600),mn=Math.floor((t%3600)/60);return `<div class="space-y-1"><div class="flex justify-between items-end"><span class="text-xs font-bold text-slate-700">${s}</span><span class="text-[10px] font-bold text-sky-600">${h>0?h+'h ':''}${mn}m</span></div><div class="subject-bar-container"><div class="subject-bar-fill" style="width: ${w}%"></div></div></div>`}).join('')||'<p class="text-xs text-slate-300 text-center py-2">学習データがありません</p>'};
const calcWkTotal=(ft)=>{const t=new Date(),ts=getTodayStr(),d=t.getDay(),s=new Date(t.setDate(t.getDate()-d));let ttl=0;for(let i=0;i<7;i++){const d=new Date(s);d.setDate(s.getDate()+i);const ds=d.toISOString().split('T')[0];if(ds===ts&&ft!==undefined)ttl+=ft;else ttl+=(S.timeRecords[ds]||0)}return ttl};
const calcMnTotal=(ft)=>{const ts=getTodayStr(),mp=ts.substring(0,7);let ttl=0;Object.keys(S.timeRecords).forEach(d=>{if(d.startsWith(mp)){if(d===ts&&ft!==undefined)ttl+=ft;else ttl+=S.timeRecords[d]}});if(ft!==undefined&&!S.timeRecords[ts])ttl+=ft;return ttl};
function updateTotalDisplay(ft){const ts=getTodayStr(),tsec=(ft!==undefined)?ft:(S.timeRecords[ts]||0);let ct=0,l="今日";if(S.goalScope==='day'){ct=tsec;l="今日"}else if(S.goalScope==='week'){ct=calcWkTotal(ft);l="今週"}else{ct=calcMnTotal(ft);l="今月"}elements.totalTimeDisplay.innerText=`${l}: ${formatTime(ct)}`;const tgt=S.goalScope==='day'?S.dailyGoalSec:(S.goalScope==='week'?S.weeklyGoalSec:S.monthlyGoalSec);if(tgt>0){const p=Math.min(100,Math.floor((ct/tgt)*100));elements.headerGoalFill.style.width=`${p}%`;elements.headerGoalPercent.innerText=`${p}%`;elements.headerGoalText.innerText=`Goal: ${(tgt/3600).toFixed(1)}h`}else{elements.headerGoalFill.style.width=`0%`;elements.headerGoalPercent.innerText=`0%`;elements.headerGoalText.innerText=`Goal: 未設定`}}
function showMessage(m){const b=elements.msgBox;b.innerText=m;b.style.opacity="1";setTimeout(()=>b.style.opacity="0",2500)}
function showConfirm(t,b,f){el('confirm-title').innerText=t;el('confirm-body').innerText=b;el('confirm-execute-btn').onclick=()=>{f();closeConfirmModal()};el('confirm-modal').classList.add('active')}
window.closeConfirmModal = () => {el('confirm-modal').classList.remove('active')};
window.exportData = () => {const d=JS(S),b=new Blob([d],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`StudyFlow_Backup_${getTodayStr()}.json`;a.click();showMessage("バックアップを作成しました")};
window.resetAllData = () => {showConfirm("全データの削除","これまでの記録がすべて消去されます。よろしいですか？",()=>{LS.clear();location.reload()})};
window.onload=()=>{el('manual-date').valueAsDate=new Date;navigate('home')};
</script></body></html>


